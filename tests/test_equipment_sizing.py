import json
import os
from typing import Annotated, Dict, Any, List, Optional, Union, Tuple

from langchain_openai import ChatOpenAI
from langchain_core.tools import tool
from langchain_core.prompts import (
    ChatPromptTemplate,
    HumanMessagePromptTemplate,
    MessagesPlaceholder,
    SystemMessagePromptTemplate,
)
from langchain_core.messages import AIMessage, BaseMessage, ToolMessage

from processdesignagents.agents.utils.agent_sizing_tools import (
    size_heat_exchanger_basic,
    size_pump_basic
)

from processdesignagents.agents.utils.agent_states import DesignState, create_design_state
from processdesignagents.agents.utils.prompt_utils import jinja_raw
from processdesignagents.agents.utils.json_tools import (
    extract_first_json_document,
)
from processdesignagents.agents.utils.equipment_stream_markdown import equipments_and_streams_dict_to_markdown

from processdesignagents.default_config import DEFAULT_CONFIG

def load_example_data() -> Dict[str, Any]:
    """ Example information from last sucessful project. (2025-10-17)"""
    temp_data = {
    "problem_statement": "design the carbon capture modular package, the feed to the package can be flue gas from various burner type. The target CO2 purity is 99.5%",
    "requirements": "## Objective\n- Primary goal: Design a modular carbon capture package for flue gas treatment\n- Key drivers: Emission Reduction\n\n## Capacity\nThe design capacity of the carbon capture unit is Not specified, based on Not specified.\n\n## Components\nThe chemical components involved in the process are:\n- Carbon Dioxide ($CO_2$)\n- Nitrogen ($N_2$) (Inferred component of flue gas)\n- Oxygen ($O_2$) (Inferred component of flue gas)\n- Water ($H_2O$) (Inferred component of flue gas)\n- Argon (Ar) (Inferred component of flue gas)\n- Trace pollutants (e.g., $SO_x$, $NO_x$, particulates) (Inferred components of flue gas)\n\n## Purity Target\n- Component: Carbon Dioxide ($CO_2$)\n- Value: 99.5%\n\n## Constraints & Assumptions\n- The feed source is flue gas from various burner types, implying variable composition and temperature.\n- The unit must be modular.\n- The system must handle typical flue gas components (e.g., $N_2$, $O_2$, $H_2O$, trace pollutants).\n- Feed pressure and temperature are Not specified.\n- Target recovery rate of $CO_2$ is Not specified.",
    "research_concepts": "{\"evaluations\": [{\"name\": \"Modular Amine Scrubbing (MEA/PZ)\", \"maturity\": \"conventional\", \"summary\": \"This is the most mature and proven technology capable of meeting the high purity target (99.5% CO2). However, its conventional nature means a high energy penalty for solvent regeneration and significant operational sensitivity to flue gas contaminants, necessitating robust and potentially complex pre-treatment.\", \"feasibility_score\": 8, \"risks\": {\"technical\": \"High sensitivity of amine solvents to trace pollutants ($SO_x$, $NO_x$, particulates) in variable flue gas feeds requires extensive, reliable pre-treatment, adding complexity and potential downtime.\", \"economic\": \"The high thermal energy demand for solvent regeneration (steam) translates directly into high operating expenditures (OPEX), making the cost per ton of captured CO2 potentially uncompetitive without cheap utility sources.\", \"safety_operational\": \"Amine degradation products can be corrosive, requiring specialized metallurgy and increasing maintenance costs. Solvent loss (volatility) and handling pose environmental and safety concerns.\"}, \"recommendations\": [\"Mandate a detailed front-end engineering design (FEED) study focused specifically on the pre-treatment section to ensure robustness against worst-case flue gas compositions.\", \"Evaluate advanced, low-heat-of-reaction solvents (e.g., PZ-enhanced) to minimize the steam consumption required for regeneration.\", \"Design the modular skid to incorporate automated solvent monitoring and makeup systems to manage degradation and loss.\"], \"concept\": {\"name\": \"Modular Amine Scrubbing (MEA/PZ)\", \"maturity\": \"conventional\", \"description\": \"This concept utilizes established chemical absorption technology, typically using monoethanolamine (MEA) or piperazine (PZ) enhanced solvents. The process involves contacting the flue gas with the solvent in an absorber column, followed by solvent regeneration in a stripper column using steam, producing high-purity CO2. Pre-treatment for trace pollutants (SOx, particulates) is essential due to solvent sensitivity. Modularity is achieved by skid-mounting the absorber, stripper, heat exchangers, and pumps.\", \"unit_operations\": [\"Flue Gas Pre-treatment (Quench/Scrubber)\", \"Amine Absorber Column\", \"Amine Stripper/Regenerator Column\", \"Reboiler and Condenser\", \"Heat Exchangers (Lean/Rich)\", \"CO2 Compressor/Drying Unit\"], \"key_benefits\": [\"High CO2 capture efficiency and proven reliability.\", \"Produces high-purity CO2 (meeting 99.5% target).\", \"Well-understood kinetics and operational parameters.\"]}}, {\"name\": \"Modular Vacuum Swing Adsorption (VSA) with Zeolites\", \"maturity\": \"innovative\", \"summary\": \"VSA offers a potentially lower-energy alternative, leveraging solid adsorbents. While modularity is inherent, achieving the required 99.5% purity from low-concentration flue gas using VSA alone is technically challenging and typically requires complex multi-stage cycles or polishing steps.\", \"feasibility_score\": 5, \"risks\": {\"technical\": \"Achieving 99.5% CO2 purity requires complex, multi-bed, multi-step VSA cycles (e.g., VPSA or hybrid systems) that reduce throughput and increase cycle complexity, making robust control difficult.\", \"economic\": \"The high capital cost (CAPEX) of specialized, tailored adsorbents (zeolites/MOFs) and high-throughput vacuum pump systems can outweigh the OPEX savings from reduced thermal energy.\", \"safety_operational\": \"Adsorbent degradation (e.g., due to moisture or temperature spikes) can lead to rapid performance decay. Particulate contamination from flue gas can blind the adsorbent beds, requiring frequent and complex regeneration or replacement.\"}, \"recommendations\": [\"Conduct pilot testing using representative variable flue gas feeds to validate the adsorbent lifetime and stability under cyclic operation.\", \"Focus R&D on simplified VSA cycles or hybrid VSA/membrane approaches that can reliably achieve the 99.5% purity target without excessive energy input.\", \"Require vendor guarantees on adsorbent performance and replacement schedules to accurately model long-term economic viability.\"], \"concept\": {\"name\": \"Modular Vacuum Swing Adsorption (VSA) with Zeolites\", \"maturity\": \"innovative\", \"description\": \"This concept uses specialized solid adsorbents, such as tailored zeolites or Metal-Organic Frameworks (MOFs), which selectively bind CO2 at near-ambient pressure. Regeneration is achieved by reducing the pressure (vacuum swing). The modular design utilizes multiple fixed-bed adsorber vessels operating in a cyclic, staggered manner (adsorption, blowdown, evacuation) to ensure continuous operation. This approach avoids the high energy penalty of solvent regeneration and is highly scalable.\", \"unit_operations\": [\"Flue Gas Pre-treatment (Dehumidification/Particulate Filter)\", \"Multi-Bed Adsorption Vessels\", \"Vacuum Pump System\", \"Pressure Swing Valves and Manifolds\", \"CO2 Compressor\"], \"key_benefits\": [\"Lower energy consumption compared to thermal regeneration (amine).\", \"Dry process minimizes water handling and corrosion issues.\", \"Inherently modular and easily scalable by adding beds.\"]}}, {\"name\": \"Modular Membrane Contactor Hybrid System\", \"maturity\": \"innovative\", \"summary\": \"This hybrid system offers significant footprint reduction and intensified mass transfer, making it highly suitable for modular deployment. However, the long-term reliability and stability of membrane contactors in complex flue gas environments, particularly regarding wetting and fouling, remain key technical hurdles.\", \"feasibility_score\": 6, \"risks\": {\"technical\": \"Membrane wetting (when liquid solvent enters the membrane pores) severely degrades performance and is difficult to reverse, requiring extremely precise control over flue gas humidity and pressure differentials.\", \"economic\": \"The high cost of advanced membrane modules and the need for specialized, often proprietary, solvents increase both initial CAPEX and long-term solvent replacement costs.\", \"safety_operational\": \"The intensified nature of the process means that small operational upsets (e.g., temperature spikes or flow variations) can have a disproportionately large impact on overall system performance and stability.\"}, \"recommendations\": [\"Focus on validating membrane material stability and anti-wetting coatings through extended field trials using real flue gas feeds.\", \"Prioritize the use of non-volatile, stable ionic liquids or advanced solvents designed specifically for membrane contactors to minimize environmental and safety risks.\", \"Develop robust, automated cleaning-in-place (CIP) protocols to manage potential fouling and maintain membrane flux over time.\"], \"concept\": {\"name\": \"Modular Membrane Contactor Hybrid System\", \"maturity\": \"innovative\", \"description\": \"A hybrid system combining selective gas separation membranes with a solvent absorption loop. The membrane contactor replaces the conventional packed column, allowing for high surface area contact between flue gas and a liquid solvent (e.g., potassium carbonate or advanced ionic liquids) without dispersion or flooding limitations. This intensifies the capture process, reducing footprint and improving mass transfer efficiency, ideal for modular deployment. A subsequent stripping stage regenerates the solvent.\", \"unit_operations\": [\"Flue Gas Pre-treatment\", \"Hollow Fiber Membrane Contactor Modules\", \"Solvent Circulation Loop\", \"Stripper/Regenerator\", \"CO2 Compressor and Purification\"], \"key_benefits\": [\"Significant reduction in equipment size and footprint (high volumetric efficiency).\", \"Decouples hydrodynamics and mass transfer, improving operational flexibility.\", \"Potential for use with less volatile and more energy-efficient solvents.\"]}}, {\"name\": \"Cryogenic Flash Separation (Integrated Pre-cooling)\", \"maturity\": \"state_of_the_art\", \"summary\": \"Cryogenic separation inherently produces high-purity CO2, meeting the 99.5% target and delivering a liquid product. However, it is highly sensitive to variable feed composition and requires massive energy input for cooling and compression, making it generally unsuitable for low-concentration flue gas unless waste heat or cheap electricity is abundant.\", \"feasibility_score\": 4, \"risks\": {\"technical\": \"The presence of trace components (especially water and $SO_x$) can lead to solid formation (freezing/desublimation) in heat exchangers, causing blockages and catastrophic equipment failure if not meticulously pre-treated and controlled.\", \"economic\": \"The extremely high electrical demand for the compression train and refrigeration cycle results in prohibitive OPEX for typical flue gas concentrations (3-15% CO2), making the process economically viable only for high-concentration streams.\", \"safety_operational\": \"Operating large-scale cryogenic equipment presents significant safety hazards related to handling extremely cold fluids, potential for brittle fracture, and the need for highly specialized maintenance personnel.\"}, \"recommendations\": [\"Restrict this technology evaluation solely to high-concentration CO2 sources (e.g., cement or fermentation off-gas) where the energy penalty is justified.\", \"If applied to flue gas, a detailed energy integration study must prove that waste heat recovery can offset at least 50% of the required refrigeration load.\", \"Implement redundant, multi-stage pre-treatment systems (drying and contaminant removal) to ensure absolute prevention of solid formation within the cryogenic section.\"], \"concept\": {\"name\": \"Cryogenic Flash Separation (Integrated Pre-cooling)\", \"maturity\": \"state_of_the_art\", \"description\": \"This concept involves deep cooling and compression of the pre-treated flue gas stream until CO2 condenses and separates as a liquid or solid (desublimation). Given the variable feed, an integrated heat pump and heat exchange network are used to minimize external refrigeration costs. Final purification involves a flash separation stage to achieve the 99.5% purity target. This is highly energy intensive but avoids chemical consumption and produces a ready-to-transport liquid product.\", \"unit_operations\": [\"Flue Gas Compression Train\", \"Multi-Stage Heat Exchanger Network (Cryogenic)\", \"Turboexpander/Refrigeration Cycle (Heat Pump)\", \"CO2 Condenser/Desublimer\", \"Flash Separator/Distillation Column (for final purity)\", \"CO2 Storage Buffer\"], \"key_benefits\": [\"Produces high-purity CO2 (liquid form) without chemical solvents.\", \"Suitable for high-pressure storage or transport directly.\", \"Minimal waste streams other than captured CO2.\"]}}]}",
    "selected_concept_name": "Modular Amine Scrubbing (MEA/PZ)",
    "selected_concept_details": "## Concept Summary\n- Name: Modular Amine Scrubbing (MEA/PZ)\n- Intent: Capture CO2 from variable flue gas sources using chemical absorption to meet a 99.5% purity target.\n- Feasibility Score (from review): 8\n\n## Process Narrative\nThe process begins with the raw flue gas feed, which is highly variable in composition and temperature. Due to the high sensitivity of the amine solvent, the flue gas must first enter a robust Flue Gas Pre-treatment section (likely a quench and/or wet scrubber) to remove particulates, $SO_x$, $NO_x$, and cool the stream to the optimal absorption temperature (TBD, typically 40-60\u00b0C). The cleaned, cooled flue gas then enters the bottom of the Amine Absorber Column. Lean amine solvent (MEA or PZ-enhanced) flows counter-currently from the top, chemically reacting with and absorbing the $CO_2$. The cleaned flue gas (vent gas) exits the top of the absorber.\n\nThe $CO_2$-rich solvent (rich amine) exits the bottom of the absorber, passes through a Lean/Rich Heat Exchanger to recover heat, and is then pumped to the Amine Stripper/Regenerator Column. Here, low-pressure steam supplied by the Reboiler heats the solvent, reversing the chemical reaction and releasing high-purity $CO_2$. The steam/CO2 mixture is cooled in the Condenser to separate water, which is returned to the column. The resulting high-purity $CO_2$ stream is then sent to the $CO_2$ Compressor/Drying Unit for final purification and pressurization for transport or sequestration. The regenerated (lean) amine solvent is cooled in the Lean/Rich Heat Exchanger and returned to the Absorber, completing the solvent loop.\n\n## Major Equipment & Roles\n| Equipment | Function | Critical Operating Notes |\n|---|---|---|\n| Flue Gas Pre-treatment (Scrubber/Quench) | Remove contaminants ($SO_x$, particulates) and cool the flue gas. | Must achieve contaminant levels below 5 ppmv to prevent irreversible solvent degradation. Requires continuous water makeup. |\n| Amine Absorber Column | Contact flue gas with lean amine to chemically absorb $CO_2$. | Maintain optimal temperature (TBD) and solvent flow rate (L/G ratio) for maximum capture efficiency. |\n| Amine Stripper/Regenerator Column | Heat rich amine to release $CO_2$ and regenerate the solvent. | Requires a consistent supply of low-pressure steam (TBD pressure) to the Reboiler. Pressure control is critical for purity. |\n| Lean/Rich Heat Exchanger | Recover thermal energy from hot lean amine to pre-heat rich amine. | Maximize heat recovery to minimize steam consumption in the Reboiler (critical for OPEX). |\n| Reboiler | Supply thermal energy (steam) to the Stripper for solvent regeneration. | Design must handle potential fouling from degraded solvent. High thermal efficiency required. |\n| CO2 Compressor/Drying Unit | Pressurize and dry the captured $CO_2$ to meet transport/sequestration specifications. | Multi-stage compression with intercoolers. Must achieve a water content suitable for 99.5% purity and pipeline specifications. |\n\n## Operating Envelope\n- Design capacity: TBD (Must be defined by required CO2 removal rate, likely expressed in tonnes/day).\n- Key pressure levels: Absorber operates near atmospheric pressure (TBD, likely 1.01-1.1 bara). Stripper operates at elevated pressure (TBD, likely 1.5-3.0 bara) to facilitate $CO_2$ compression.\n- Key temperature levels: Absorber inlet (flue gas) TBD (likely 40-60\u00b0C). Stripper Reboiler temperature TBD (likely 110-120\u00b0C).\n- Special utilities / additives: Low-pressure steam (primary utility for regeneration), cooling water (for Condenser and intercoolers), process water (for pre-treatment quench), Amine solvent (MEA or PZ-enhanced) makeup.\n\n## Risks & Safeguards\n| Process Risk | Mitigation / Safeguard |\n|---|---|\n| Flue gas contamination causes rapid solvent degradation and corrosion. | Install continuous online analyzers for $SO_x$/particulates post-pre-treatment with automatic diversion/shutdown if limits are exceeded. Specify corrosion-resistant metallurgy (e.g., stainless steel) in high-temperature/high-concentration sections. |\n| High steam consumption leads to excessive operating costs (OPEX). | Implement advanced control strategies (e.g., dynamic solvent flow adjustment) to minimize the specific reboiler duty (GJ/tonne CO2). Use PZ-enhanced solvent to lower the heat of reaction. |\n| Solvent loss via evaporation or entrainment (environmental/safety risk). | Install a solvent wash section (water wash) at the top of the Absorber. Implement continuous solvent level and concentration monitoring with automated makeup and strict process control on temperature. |\n| Foaming in Absorber/Stripper reduces efficiency. | Install automated anti-foam injection system triggered by differential pressure monitoring across the column packing. |\n\n## Data Gaps & Assumptions\n- The required CO2 recovery rate (e.g., 90%) is **TBD**. This is necessary to size the Absorber and determine solvent circulation rate.\n- Detailed characterization of the flue gas feed (min/max flow, $CO_2$ concentration, temperature, and worst-case $SO_x$/$NO_x$ levels) is **TBD**. This directly impacts the pre-treatment design.\n- The specific solvent (MEA concentration vs. PZ-enhanced) is **TBD**; selection will depend on the final OPEX/CAPEX trade-off study.\n- The required pressure and dryness specification for the final captured $CO_2$ product (for transport/sequestration) is **TBD**.\n- Steam availability pressure and cost are **TBD**, which is critical for the economic evaluation.",
    "design_basis": "# Preliminary Process Basis of Design (BoD)\n\n## 1. Project Overview and Problem Statement\nThis document provides the preliminary basis for the design of a new modular Carbon Capture Unit (CCU) utilizing Amine Scrubbing technology. The primary objective is to capture CO2 from variable flue gas sources (various burner types) and produce a high-purity CO2 product meeting a minimum specification of 99.5% (mol/mol). The unit must be designed as a modular package to facilitate transport and rapid deployment.\n\n## 2. Key Design Assumptions and Exclusions\n*   **Process Technology:** Modular Amine Scrubbing (MEA or PZ-enhanced) is selected as the most commercially proven method to achieve the required CO2 purity target.\n*   **Operating Factor:** A minimum operating factor of 8,400 hours per year (95.9% stream factor) is assumed for continuous operation, typical for utility/industrial applications.\n*   **CO2 Recovery Target:** A preliminary minimum CO2 recovery rate of **90%** is assumed for sizing the absorption section, pending final project requirements.\n*   **Flue Gas Contaminants:** The Flue Gas Pre-treatment section is assumed capable of reducing $SO_x$ and particulate matter to below 5 ppmv at the Absorber inlet, which is necessary to prevent rapid solvent degradation.\n*   **Design Margin:** A 10% capacity margin shall be applied to the required nameplate CO2 capture rate.\n*   **Modularity:** The entire process (Pre-treatment, Absorption/Stripping, Compression/Drying) will be divided into transportable, skid-mounted modules (maximum dimensions TBD by site logistics).\n*   **Exclusions:** This preliminary BoD excludes final $CO_2$ pipeline pressure specifications, detailed utility balances, control system logic, and detailed mechanical equipment sizing (e.g., column diameters, compressor stages).\n\n## 3. Design Capacity and Operating Conditions\n| Parameter | Value | Units | Basis |\n| :--- | :--- | :--- | :--- |\n| **Nameplate Capacity** | TBD (Required CO2 Removal Rate) | tonnes/day | User Requirement (Missing) |\n| **Design Capacity** | Nameplate Capacity + 10% | tonnes/day | 10% Design Margin |\n| **Process Type** | Continuous Chemical Absorption/Regeneration | N/A | Amine Scrubbing |\n| **Absorber Pressure (Design)** | 1.5 | bara | Near Atmospheric (1.01 bara operating + margin) |\n| **Stripper Operating Pressure** | 1.5 - 3.0 | bara | Preliminary Estimate (Optimized for Reboiler/Compressor) |\n| **Absorber Operating Temp. (Inlet)** | 40 - 60 | \u00b0C | Optimal Amine Absorption Range |\n| **Stripper Reboiler Temp.** | 110 - 120 | \u00b0C | Required for Amine Regeneration (Solvent Dependant) |\n\n## 4. Feed and Product Specifications\n\n### Feed Specification (Variable Flue Gas)\n*   **Source:** Various Industrial Burners (Coal, Gas, Oil, Biomass)\n*   **CO2 Concentration (Range):** 3 - 15 | mol% | Highly Variable (Design must accommodate range)\n*   **Temperature (Pre-treatment Inlet Max):** 350 | \u00b0C | Preliminary Max Estimate\n*   **SOx/Particulate Content (Pre-treatment Outlet Max):** 5 | ppmv | Critical Solvent Protection Limit\n*   **Oxygen Content (Max):** 10 | mol% | Assumed based on typical combustion\n\n### Product Specification (Captured CO2)\n*   **Target Purity:** 99.5 | mol% | User Requirement\n*   **Water Content (Max):** 50 | ppmv | Assumed for Pipeline/Sequestration Safety (Post-Drying)\n*   **H2S/COS (Max):** 1 | ppmv | Assumed for Pipeline/Sequestration Safety\n\n## 5. Preliminary Utility Summary\n*   **Primary Energy Utility (Heat):** Low-Pressure (LP) Steam (3-5 barg) required for the Stripper Reboiler. This is the largest utility consumer.\n*   **Cooling Utility:** Cooling Water (CW) required for the Absorber intercoolers, Stripper Condenser, and CO2 Compressor intercoolers.\n*   **Electrical Power:** Required for all pumps (Amine, Water), Blowers (if needed), and the multi-stage CO2 Compressor train.\n*   **Process Water:** Required for Flue Gas Quench/Scrubber and Amine Solvent Wash section makeup. Water quality must be suitable for steam generation and process use.\n*   **Chemicals:** Amine Solvent (MEA or PZ-enhanced) makeup, Anti-foam agents, Corrosion Inhibitors, and Pre-treatment scrubber chemicals (e.g., caustic soda if required).\n\n## 6. Environmental and Regulatory Criteria\n*   **Vent Gas Emissions:** The cleaned flue gas (vent gas) exiting the Absorber must meet local environmental regulations for CO2 reduction (defined by the assumed 90% recovery rate) and must ensure minimal Amine carryover (e.g., <1 ppmv Amine).\n*   **Wastewater:** Wastewater from the Flue Gas Pre-treatment Scrubber and the Amine reclamation unit (if included) must be treated to remove heavy metals, degraded amine products, and particulates before discharge or recycling.\n*   **Noise:** Due to the modular nature and potential urban proximity, the CO2 Compressor and vacuum systems must be acoustically insulated to meet site-specific noise limits.\n*   **Safety (Process Hazards):** The system must adhere to standard chemical process safety practices (HAZOP) regarding handling flammable/toxic Amine solvents and high-pressure CO2 streams.\n\n## 7. Process Selection Rationale (High-Level)\nThe selection of Modular Amine Scrubbing (MEA/PZ) is based on its proven ability to achieve high CO2 purity (99.5%) from dilute flue gas streams, a critical requirement. While the high energy demand (steam) is a drawback, the technology offers the highest operational flexibility in handling variable CO2 concentrations and is commercially mature, which reduces project risk for a modular, multi-source application. The modular design will focus heavily on optimizing the Lean/Rich Heat Exchanger and utilizing advanced solvents (PZ-enhanced) to minimize the specific reboiler duty (GJ/tonne CO2).\n\n## 8. Preliminary Material of Construction (MoC) Basis\n*   **Flue Gas Pre-treatment:** Fiberglass Reinforced Plastic (FRP) or specialized alloys (e.g., 316L SS) required due to low pH and high chloride/SOx content in the scrubber/quench environment.\n*   **Absorber Column:** Carbon Steel (CS) with internal stainless steel (304L/316L) cladding or lining, particularly at the solvent inlet and high-velocity zones.\n*   **Stripper Column/Reboiler:** Stainless Steel (316L SS) is mandatory due to the high temperature (110-120\u00b0C) and high concentration of corrosive, regenerated amine solvent.\n*   **CO2 Compressor/Drying:** Carbon Steel (CS) for initial stages; Stainless Steel (304L) for final stages and drying unit to ensure product purity and corrosion resistance from trace moisture.",
    "basic_pfd": "## Flowsheet Summary\n- Concept: Modular Amine Scrubbing CCU\n- Objective: Capture CO2 from variable flue gas sources with 90% recovery and achieve 99.5% CO2 purity product.\n- Key Drivers: Modularity, high purity, and robust handling of variable flue gas contaminants.\n\n## Units\n| ID | Name | Type | Description |\n| :--- | :--- | :--- | :--- |\n| V-101 | Flue Gas Pre-treatment Scrubber | Packed Column (Quench/Scrubber) | Cools flue gas and removes particulates, SOx, and NOx to <5 ppmv. |\n| C-101 | Amine Absorber Column | Packed/Tray Column | Counter-current contact of cleaned flue gas with lean amine to capture CO2. Includes a water wash section. |\n| P-101 | Rich Amine Pump | Centrifugal Pump | Boosts rich amine pressure from Absorber bottom to Stripper inlet pressure. |\n| E-101 | Lean/Rich Heat Exchanger | Shell-and-tube | Recovers heat from hot lean amine (2007) to pre-heat rich amine (1003). |\n| C-201 | Amine Stripper/Regenerator | Packed/Tray Column | Regenerates rich amine using heat (steam) to release CO2. |\n| E-201 | Stripper Reboiler | Kettle or Thermosyphon | Provides thermal energy (LP Steam) to boil solvent and drive the regeneration reaction. |\n| E-202 | Overhead Condenser | Shell-and-tube | Cools the overhead vapor (CO2/H2O) to condense water vapor. |\n| V-201 | Reflux Drum | Separator Vessel | Separates condensed water (reflux) from the wet CO2 product. |\n| P-201 | Lean Amine Pump | Centrifugal Pump | Circulates regenerated lean amine back to the Absorber feed. |\n| P-202 | Reflux Pump | Centrifugal Pump | Returns condensed water from V-201 back to C-201 top as reflux. |\n| K-301 | CO2 Compressor Train | Multi-stage Centrifugal/Reciprocating | Compresses wet CO2 product to pipeline/sequestration pressure. |\n| D-301 | CO2 Drying Unit | Adsorption Bed (e.g., Molecular Sieve) | Removes residual moisture to meet 50 ppmv water specification. |\n| U-401 | Low Pressure Steam (LPS) | Utility Header | Supplies steam for E-201 Reboiler. |\n| U-402 | Cooling Water (CW) | Utility Header | Supplies cooling water for E-202 and K-301 intercoolers. |\n| U-403 | Process Water (PW) | Utility Header | Supplies makeup water for V-101 and C-101 wash section. |\n\n## Streams\n| ID | Stream | From | To | Description |\n| :--- | :--- | :--- | :--- | :--- |\n| 1001 | Raw Flue Gas Feed | Source (Burner) | V-101 | High-temp, variable composition, contaminated flue gas. |\n| 1002 | Cleaned Flue Gas | V-101 | C-101 | Cooled (40-60\u00b0C), low-contaminant flue gas ready for absorption. |\n| 1003 | Rich Amine (Low P) | C-101 | E-101 | CO2-loaded solvent leaving the Absorber bottom. |\n| 1004 | Rich Amine (High P) | P-101 | E-101 | Rich amine pumped to Stripper pressure. |\n| 1005 | Pre-heated Rich Amine | E-101 | C-201 | Rich amine pre-heated by lean solvent before entering Stripper. |\n| 1006 | Stripper Overhead Vapor | C-201 | E-202 | Hot mixture of CO2 and steam. |\n| 1007 | Wet CO2 Product | V-201 | K-301 | High-purity CO2 saturated with water vapor. |\n| 1008 | Dry CO2 Product | D-301 | Export/Pipeline | Final product (99.5% purity, <50 ppmv H2O). |\n| 2001 | Lean Amine (Hot) | C-201 | E-101 | Regenerated solvent leaving Stripper bottom (110-120\u00b0C). |\n| 2002 | Lean Amine (Cooled) | E-101 | P-201 | Lean amine cooled by rich amine (heat recovery). |\n| 2003 | Lean Amine Feed | P-201 | C-101 | Lean amine pumped and cooled for absorption (40-60\u00b0C). |\n| 3001 | Vent Gas (Cleaned) | C-101 | Stack | Flue gas with reduced CO2 content (90% removed). |\n| 3002 | Pre-treatment Blowdown | V-101 | Wastewater Treatment | Contaminated water removed from the scrubber/quench system. |\n| 4001 | LPS Supply | U-401 | E-201 | Low-pressure steam utility for regeneration. |\n| 4002 | Condensate Return | E-201 | Utility Return | Condensed steam from Reboiler. |\n| 4003 | CW Supply | U-402 | E-202, K-301 | Cooling water utility supply. |\n| 4004 | CW Return | E-202, K-301 | Utility Return | Warmed cooling water return. |\n| 4005 | Reflux Water | V-201 | C-201 | Condensed water returned to Stripper top for reflux. |\n| 4006 | Amine Makeup/Additives | Storage | P-201/C-101 | Solvent makeup and anti-foam/corrosion inhibitor addition. |\n\n## Overall Description\nThe raw flue gas (1001) first enters the **Flue Gas Pre-treatment Scrubber (V-101)**, where it is quenched and scrubbed to remove particulates and acidic contaminants ($SO_x$) to protect the solvent. The cleaned, cooled gas (1002) feeds the bottom of the **Amine Absorber (C-101)**. Lean amine solvent (2003) flows counter-currently, absorbing CO2. The cleaned vent gas (3001) exits the top.\n\nThe CO2-loaded rich amine (1003) is pumped (P-101) and pre-heated in the **Lean/Rich Heat Exchanger (E-101)** (1005) before entering the **Amine Stripper (C-201)**. Low-Pressure Steam (4001) supplies heat via the **Reboiler (E-201)**, stripping the CO2. The hot, regenerated lean amine (2001) is cooled in E-101 (2002) and pumped (P-201) back to the Absorber (2003).\n\nThe Stripper overhead vapor (1006) is condensed (E-202), and water is separated in the **Reflux Drum (V-201)**, with the condensate returned (4005) to C-201. The wet CO2 product (1007) is compressed in the **Compressor Train (K-301)** and dried in the **Drying Unit (D-301)** to meet the final purity and water specification (1008).\n\n## Notes\n- **Modularity:** The process is conceptually divided into three main skids: 1) Pre-treatment/Quench (V-101 and associated pumps/filters), 2) Absorption/Regeneration Loop (C-101, C-201, E-101, E-201, pumps), and 3) CO2 Compression/Drying (K-301, D-301, V-201).\n- **Advanced Integration:** E-101 (Lean/Rich Heat Exchanger) is the single most critical component for OPEX. A high-efficiency plate-and-frame or spiral heat exchanger is recommended to maximize heat recovery and minimize steam consumption (4001).\n- **Instrumentation:** Continuous online analyzers for $SO_x$ and particulates must be installed on stream 1002 (Cleaned Flue Gas) to ensure contaminant levels are below 5 ppmv. This data should trigger an automated shutdown or bypass if limits are exceeded, protecting the amine inventory.\n- **Safety:** The CO2 Compressor (K-301) requires robust intercooling and moisture removal to prevent hydrate formation and corrosion. The final drying unit (D-301) is mandatory to meet the 50 ppmv H2O requirement for pipeline safety.\n- **Solvent Management:** An Amine Reclamation Unit (not shown, but required for commercial operation) should be considered downstream of P-201 to continuously purify a small slipstream of the circulating amine, removing heat-stable salts and degradation products.",
    "stream_list_results": "{\"metadata\": {\"property_order\": [{\"key\": \"mass_flow\", \"label\": \"Mass Flow\", \"units\": \"kg/h\"}, {\"key\": \"molar_flow\", \"label\": \"Molar Flow\", \"units\": \"kmol/h\"}, {\"key\": \"temperature\", \"label\": \"Temperature\", \"units\": \"\u00b0C\"}, {\"key\": \"pressure\", \"label\": \"Pressure\", \"units\": \"bara\"}], \"component_basis\": \"mol %\", \"component_order\": [\"CO2\", \"N2\", \"O2\", \"H2O\", \"Amine Solvent\", \"Trace Contaminants (SOx/NOx)\"], \"assumptions\": [\"Design basis is 110 tonnes/day CO2 captured (90% recovery from flue gas).\", \"Flue gas feed basis: 10 mol% CO2, 75 mol% N2, 5 mol% O2, 9.9 mol% H2O, 0.1 mol% contaminants.\", \"Solvent: 30 wt% MEA in water. Circulation rate based on 0.4 (rich) and 0.1 (lean) CO2 loadings.\", \"Stripper reboiler duty estimated at 3.8 GJ/tonne CO2 for stripping plus sensible heating.\", \"Steam generation for reboiler based on latent heat at 4 barg (5 bara).\", \"Stripper overhead condensing assumes total condensation with a 1.0 reflux ratio (by mass).\", \"CO2 product compression to 100 barg for pipeline transport.\", \"Pre-treatment removes 100% of trace contaminants and 90% of water vapor, with 5000 kg/h quench water.\"]}, \"streams\": [{\"id\": \"1001\", \"name\": \"Raw Flue Gas Feed\", \"description\": \"High-temp, variable composition, contaminated flue gas entering pre-treatment.\", \"from\": \"Source (Burner)\", \"to\": \"V-101\", \"phase\": \"Vapor\", \"properties\": {\"mass_flow\": \"33386 kg/h\", \"molar_flow\": \"1157.4 kmol/h\", \"temperature\": \"350\", \"pressure\": \"1.01\"}, \"components\": {\"CO2\": \"10.0\", \"N2\": \"75.0\", \"O2\": \"5.0\", \"H2O\": \"9.9\", \"Amine Solvent\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0.1\"}, \"notes\": \"Basis case for a 10 mol% CO2 flue gas stream.\"}, {\"id\": \"1002\", \"name\": \"Cleaned Flue Gas\", \"description\": \"Cooled, low-contaminant flue gas ready for absorption.\", \"from\": \"V-101\", \"to\": \"C-101\", \"phase\": \"Vapor\", \"properties\": {\"mass_flow\": \"31456 kg/h\", \"molar_flow\": \"1053.1 kmol/h\", \"temperature\": \"50\", \"pressure\": \"1.05\"}, \"components\": {\"CO2\": \"11.0\", \"N2\": \"82.4\", \"O2\": \"5.5\", \"H2O\": \"1.1\", \"Amine Solvent\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Contaminants removed to <5 ppmv. Water content reduced after quench/scrubbing.\"}, {\"id\": \"1003\", \"name\": \"Rich Amine (Low P)\", \"description\": \"CO2-loaded solvent leaving the Absorber bottom.\", \"from\": \"C-101\", \"to\": \"P-101\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"70597 kg/h\", \"molar_flow\": \"3196.8 kmol/h\", \"temperature\": \"50\", \"pressure\": \"1.1\"}, \"components\": {\"CO2\": \"4.3\", \"N2\": \"0\", \"O2\": \"0\", \"H2O\": \"85.5\", \"Amine Solvent\": \"10.2\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Solvent circulation rate sized for 110 t/day CO2 capture at 0.4 mol CO2/mol MEA loading.\"}, {\"id\": \"1004\", \"name\": \"Rich Amine (High P)\", \"description\": \"Rich amine pumped to Stripper pressure.\", \"from\": \"P-101\", \"to\": \"E-101\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"70597 kg/h\", \"molar_flow\": \"3196.8 kmol/h\", \"temperature\": \"52\", \"pressure\": \"2.0\"}, \"components\": {\"CO2\": \"4.3\", \"N2\": \"0\", \"O2\": \"0\", \"H2O\": \"85.5\", \"Amine Solvent\": \"10.2\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Pressure increased for stripper feed. Slight temperature rise from pump.\"}, {\"id\": \"1005\", \"name\": \"Pre-heated Rich Amine\", \"description\": \"Rich amine pre-heated by lean solvent before entering Stripper.\", \"from\": \"E-101\", \"to\": \"C-201\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"70597 kg/h\", \"molar_flow\": \"3196.8 kmol/h\", \"temperature\": \"105\", \"pressure\": \"2.0\"}, \"components\": {\"CO2\": \"4.3\", \"N2\": \"0\", \"O2\": \"0\", \"H2O\": \"85.5\", \"Amine Solvent\": \"10.2\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Heat recovery from lean amine improves reboiler efficiency.\"}, {\"id\": \"1006\", \"name\": \"Stripper Overhead Vapor\", \"description\": \"Hot mixture of CO2 and steam leaving the top of the regenerator.\", \"from\": \"C-201\", \"to\": \"E-202\", \"phase\": \"Vapor\", \"properties\": {\"mass_flow\": \"13751 kg/h\", \"molar_flow\": \"613.5 kmol/h\", \"temperature\": \"120\", \"pressure\": \"2.0\"}, \"components\": {\"CO2\": \"17.0\", \"H2O\": \"83.0\", \"Amine Solvent\": \"0\", \"N2\": \"0\", \"O2\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Steam to CO2 ratio of ~2.0 by mass to drive regeneration.\"}, {\"id\": \"1007\", \"name\": \"Wet CO2 Product\", \"description\": \"High-purity CO2 saturated with water vapor after condensation.\", \"from\": \"V-201\", \"to\": \"K-301\", \"phase\": \"Vapor\", \"properties\": {\"mass_flow\": \"9167 kg/h\", \"molar_flow\": \"358.8 kmol/h\", \"temperature\": \"35\", \"pressure\": \"2.0\"}, \"components\": {\"CO2\": \"29.0\", \"H2O\": \"71.0\", \"N2\": \"0\", \"O2\": \"0\", \"Amine Solvent\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Purity is 100% on a dry basis. Requires drying to meet final spec.\"}, {\"id\": \"1008\", \"name\": \"Dry CO2 Product\", \"description\": \"Final product (99.5% purity, <50 ppmv H2O) ready for export.\", \"from\": \"D-301\", \"to\": \"Export/Pipeline\", \"phase\": \"Vapor\", \"properties\": {\"mass_flow\": \"4584 kg/h\", \"molar_flow\": \"104.2 kmol/h\", \"temperature\": \"25\", \"pressure\": \"100\"}, \"components\": {\"CO2\": \"99.995\", \"H2O\": \"0.005\", \"N2\": \"0\", \"O2\": \"0\", \"Amine Solvent\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Meets >99.5% purity and <50 ppmv water specifications.\"}, {\"id\": \"2001\", \"name\": \"Lean Amine (Hot)\", \"description\": \"Regenerated solvent leaving Stripper bottom (110-120\u00b0C).\", \"from\": \"C-201\", \"to\": \"E-101\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"56847 kg/h\", \"molar_flow\": \"2618.0 kmol/h\", \"temperature\": \"120\", \"pressure\": \"2.0\"}, \"components\": {\"CO2\": \"1.3\", \"H2O\": \"85.4\", \"Amine Solvent\": \"13.3\", \"N2\": \"0\", \"O2\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Lean CO2 loading of 0.1 mol/mol MEA.\"}, {\"id\": \"2002\", \"name\": \"Lean Amine (Cooled)\", \"description\": \"Lean amine cooled by rich amine (heat recovery).\", \"from\": \"E-101\", \"to\": \"P-201\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"56847 kg/h\", \"molar_flow\": \"2618.0 kmol/h\", \"temperature\": \"65\", \"pressure\": \"2.0\"}, \"components\": {\"CO2\": \"1.3\", \"H2O\": \"85.4\", \"Amine Solvent\": \"13.3\", \"N2\": \"0\", \"O2\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Cooled to provide heat to rich amine stream.\"}, {\"id\": \"2003\", \"name\": \"Lean Amine Feed\", \"description\": \"Lean amine pumped and cooled for absorption.\", \"from\": \"P-201\", \"to\": \"C-101\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"56847 kg/h\", \"molar_flow\": \"2618.0 kmol/h\", \"temperature\": \"50\", \"pressure\": \"1.5\"}, \"components\": {\"CO2\": \"1.3\", \"H2O\": \"85.4\", \"Amine Solvent\": \"13.3\", \"N2\": \"0\", \"O2\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Final temperature adjusted for optimal absorption kinetics.\"}, {\"id\": \"3001\", \"name\": \"Vent Gas (Cleaned)\", \"description\": \"Flue gas with reduced CO2 content (90% removed) vented to stack.\", \"from\": \"C-101\", \"to\": \"Stack\", \"phase\": \"Vapor\", \"properties\": {\"mass_flow\": \"26873 kg/h\", \"molar_flow\": \"949.0 kmol/h\", \"temperature\": \"50\", \"pressure\": \"1.01\"}, \"components\": {\"CO2\": \"1.2\", \"N2\": \"91.5\", \"O2\": \"6.1\", \"H2O\": \"1.2\", \"Amine Solvent\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"90% CO2 removal achieved. Amine carryover assumed negligible.\"}, {\"id\": \"3002\", \"name\": \"Pre-treatment Blowdown\", \"description\": \"Contaminated water removed from the scrubber/quench system.\", \"from\": \"V-101\", \"to\": \"Wastewater Treatment\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"6930 kg/h\", \"molar_flow\": \"385.0 kmol/h\", \"temperature\": \"50\", \"pressure\": \"1.1\"}, \"components\": {\"H2O\": \"99.0\", \"Trace Contaminants (SOx/NOx)\": \"1.0\", \"Amine Solvent\": \"0\", \"CO2\": \"0\", \"N2\": \"0\", \"O2\": \"0\"}, \"notes\": \"Includes condensed flue gas water and quench water with dissolved contaminants.\"}, {\"id\": \"4001\", \"name\": \"LPS Supply\", \"description\": \"Low-pressure steam utility for regeneration.\", \"from\": \"U-401\", \"to\": \"E-201\", \"phase\": \"Vapor\", \"properties\": {\"mass_flow\": \"10312 kg/h\", \"molar_flow\": \"572.9 kmol/h\", \"temperature\": \"152\", \"pressure\": \"5\"}, \"components\": {\"H2O\": \"100\", \"Amine Solvent\": \"0\", \"CO2\": \"0\", \"N2\": \"0\", \"O2\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Steam flow sized for 21.7 MW reboiler duty at 4 barg.\"}, {\"id\": \"4002\", \"name\": \"Condensate Return\", \"description\": \"Condensed steam from Reboiler.\", \"from\": \"E-201\", \"to\": \"Utility Return\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"10312 kg/h\", \"molar_flow\": \"572.9 kmol/h\", \"temperature\": \"152\", \"pressure\": \"5\"}, \"components\": {\"H2O\": \"100\", \"Amine Solvent\": \"0\", \"CO2\": \"0\", \"N2\": \"0\", \"O2\": \"0\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"High quality condensate return to boiler house.\"}, {\"id\": \"4003\", \"name\": \"CW Supply\", \"description\": \"Cooling water utility supply for E-202 and K-301 intercoolers.\", \"from\": \"U-402\", \"to\": \"E-202, K-301\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"579000 kg/h\", \"molar_flow\": \"32167 kmol/h\", \"temperature\": \"25\", \"pressure\": \"2.5\"}, \"components\": {\"H2O\": \"100\"}, \"notes\": \"Sized for 10\u00b0C temperature rise (25\u00b0C to 35\u00b0C).\"}, {\"id\": \"4004\", \"name\": \"CW Return\", \"description\": \"Warmed cooling water return.\", \"from\": \"E-202, K-301\", \"to\": \"Utility Return\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"579000 kg/h\", \"molar_flow\": \"32167 kmol/h\", \"temperature\": \"35\", \"pressure\": \"1.5\"}, \"components\": {\"H2O\": \"100\"}, \"notes\": \"Return temperature after absorbing process heat.\"}, {\"id\": \"4005\", \"name\": \"Reflux Water\", \"description\": \"Condensed water returned from V-201 to Stripper top for reflux.\", \"from\": \"V-201\", \"to\": \"C-201\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"4584 kg/h\", \"molar_flow\": \"254.6 kmol/h\", \"temperature\": \"35\", \"pressure\": \"2.0\"}, \"components\": {\"H2O\": \"99.995\", \"CO2\": \"0.005\"}, \"notes\": \"Reflux ratio of 1.0 by mass to control water balance.\"}, {\"id\": \"4006\", \"name\": \"Amine Makeup/Additives\", \"description\": \"Solvent makeup and anti-foam/corrosion inhibitor addition.\", \"from\": \"Storage\", \"to\": \"P-201/C-101\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": \"1.5 kg/h\", \"molar_flow\": \"0.025 kmol/h\", \"temperature\": \"25\", \"pressure\": \"2.0\"}, \"components\": {\"Amine Solvent\": \"80\", \"H2O\": \"20\", \"Trace Contaminants (SOx/NOx)\": \"0\"}, \"notes\": \"Assumes 1 kg of solvent loss per tonne of CO2 captured.\"}]}",
    "equipment_list_template": "{\"metadata\": {\"groups\": [{\"name\": \"Columns and Vessels\", \"ids\": [\"V-101\", \"C-101\", \"C-201\", \"V-201\"]}, {\"name\": \"Heat Exchangers\", \"ids\": [\"E-101\", \"E-201\", \"E-202\"]}, {\"name\": \"Pumps and Rotating Equipment\", \"ids\": [\"P-101\", \"P-201\", \"P-202\", \"K-301\"]}, {\"name\": \"Purification Units\", \"ids\": [\"D-301\"]}], \"assumptions\": [\"Process design is based on the Amine Scrubbing technology (MEA or PZ-enhanced).\", \"CO2 recovery is targeted at 90% (110 tonnes/day captured CO2).\", \"All columns are modeled as packed columns for modularity and efficiency.\", \"The CO2 Compressor (K-301) includes required intercoolers (cooling duty included in utility stream 4003/4004).\", \"Material of Construction (MoC) for high-temperature amine service (C-201, E-201, hot side of E-101) is 316L SS.\", \"Pump and compressor efficiencies are assumed to be 75%.\", \"Density of rich amine (30% MEA) is assumed to be 1100 kg/m\u00b3.\", \"Density of lean amine (30% MEA) is assumed to be 1050 kg/m\u00b3.\", \"Specific heat capacity (Cp) of amine solution is assumed to be 4.0-4.1 kJ/kg-K.\", \"CO2 compressor power is estimated using a rule of thumb of 0.12 kWh/kg CO2 for compression to 100 barg.\"]}, \"equipment\": [{\"id\": \"V-101\", \"name\": \"Flue Gas Pre-treatment Scrubber\", \"service\": \"Cool, quench, and scrub raw flue gas to remove particulates and acidic components (SOx, NOx).\", \"type\": \"Packed Column (Quench/Scrubber)\", \"streams_in\": [\"1001\", \"U-403\"], \"streams_out\": [\"1002\", \"3002\"], \"duty_or_load\": \"Cooling Duty: 10.9 MW\", \"key_parameters\": [\"Flue Gas Flow: 33386 kg/h\", \"Operating Temperature: 50 \u00b0C\", \"Contaminant Outlet Target: <5 ppmv SOx/Particulates\"], \"notes\": \"Duty calculated from cooling flue gas from 350\u00b0C to 50\u00b0C (Cp~1.1 kJ/kg-K) and heating/evaporating 6930 kg/h of quench water (Cp~4.2 kJ/kg-K, Hvap~2250 kJ/kg).\"}, {\"id\": \"C-101\", \"name\": \"Amine Absorber Column\", \"service\": \"Capture CO2 from cleaned flue gas via counter-current contact with lean amine solvent.\", \"type\": \"Packed/Tray Column\", \"streams_in\": [\"1002\", \"2003\"], \"streams_out\": [\"3001\", \"1003\"], \"duty_or_load\": \"Heat of Absorption: 1.5 MW\", \"key_parameters\": [\"Flue Gas Flow: 31456 kg/h\", \"Amine Circulation Rate: 56847 kg/h\", \"CO2 Recovery: 90%\"], \"notes\": \"Duty is an estimated value for the exothermic absorption reaction. Includes an upper water wash section to minimize amine carryover.\"}, {\"id\": \"P-101\", \"name\": \"Rich Amine Pump\", \"service\": \"Boost rich amine pressure from Absorber bottom (1.1 bara) to Stripper inlet pressure (2.0 bara).\", \"type\": \"Centrifugal Pump\", \"streams_in\": [\"1003\"], \"streams_out\": [\"1004\"], \"duty_or_load\": \"Power: 2.1 kW\", \"key_parameters\": [\"Differential Head: 0.9 bar\", \"Flow Rate: 70.6 m\u00b3/h\", \"Efficiency (Assumed): 75%\"], \"notes\": \"Power calculated using P = (\u0394P * Q) / \u03b7. MoC to be 304L SS due to CO2-loaded amine.\"}, {\"id\": \"E-101\", \"name\": \"Lean/Rich Heat Exchanger\", \"service\": \"Recover heat from hot lean amine (2001) to pre-heat rich amine (1004) before stripping.\", \"type\": \"Shell-and-tube or Plate-and-frame\", \"streams_in\": [\"1004\", \"2001\"], \"streams_out\": [\"1005\", \"2002\"], \"duty_or_load\": \"Heat Duty: 4.2 MW\", \"key_parameters\": [\"Hot Stream Inlet Temp: 120 \u00b0C\", \"Cold Stream Outlet Temp: 105 \u00b0C\", \"Minimum Approach Temp: 5 \u00b0C\"], \"notes\": \"Duty calculated from the energy balance on the cold (rich amine) stream: Q = m_dot * Cp * \u0394T. Critical for OPEX. MoC 316L SS on hot side.\"}, {\"id\": \"C-201\", \"name\": \"Amine Stripper/Regenerator\", \"service\": \"Regenerate rich amine by thermal energy, releasing high-purity CO2.\", \"type\": \"Packed/Tray Column\", \"streams_in\": [\"1005\", \"4005\"], \"streams_out\": [\"1006\", \"2001\"], \"duty_or_load\": \"Reboiler Duty: 21.7 MW\", \"key_parameters\": [\"Operating Pressure: 2.0 bara\", \"Bottom Temperature: 120 \u00b0C\", \"Lean Loading Target: 0.1 mol CO2/mol Amine\"], \"notes\": \"Duty estimated from design basis (3.8 GJ/tonne CO2 for 110 t/day). MoC 316L SS required for high-temperature, corrosive service.\"}, {\"id\": \"E-201\", \"name\": \"Stripper Reboiler\", \"service\": \"Provide thermal energy (LP Steam) to boil solvent at the Stripper bottom.\", \"type\": \"Kettle or Thermosyphon\", \"streams_in\": [\"4001\"], \"streams_out\": [\"4002\"], \"duty_or_load\": \"Heat Duty: 21.7 MW\", \"key_parameters\": [\"Steam Supply Pressure: 5 bara\", \"Steam Flow Rate: 10312 kg/h\", \"Design Factor: 1.1\"], \"notes\": \"Duty provided to C-201. MoC 316L SS mandatory. Design must account for potential fouling.\"}, {\"id\": \"E-202\", \"name\": \"Overhead Condenser\", \"service\": \"Cool and condense steam from the Stripper overhead (1006) using Cooling Water.\", \"type\": \"Shell-and-tube\", \"streams_in\": [\"1006\", \"4003\"], \"streams_out\": [\"V-201\", \"4004\"], \"duty_or_load\": \"Cooling Duty: 4.2 MW\", \"key_parameters\": [\"Outlet Temperature: 35 \u00b0C\", \"CW Temperature Rise: 10 \u00b0C\"], \"notes\": \"Duty estimated from total CW load (6.7 MW) minus estimated compressor intercooler load (2.5 MW). MoC 304L SS required.\"}, {\"id\": \"V-201\", \"name\": \"Reflux Drum\", \"service\": \"Separate condensed water (reflux) from the wet CO2 product (1007).\", \"type\": \"Separator Vessel (Horizontal)\", \"streams_in\": [\"E-202\"], \"streams_out\": [\"1007\", \"4005\"], \"duty_or_load\": \"Volume: 1.2 m\u00b3\", \"key_parameters\": [\"Liquid Holdup Time: 5 min\", \"Operating Pressure: 2.0 bara\"], \"notes\": \"Volume sized based on 5 minutes holdup for total liquid and vapor outflow (13.75 m\u00b3/h).\"}, {\"id\": \"P-201\", \"name\": \"Lean Amine Pump\", \"service\": \"Circulate regenerated lean amine (2002) back to the Absorber inlet (2003).\", \"type\": \"Centrifugal Pump\", \"streams_in\": [\"2002\"], \"streams_out\": [\"2003\"], \"duty_or_load\": \"Power: 1.0 kW\", \"key_parameters\": [\"Differential Head: 0.5 bar\", \"Flow Rate: 56.8 m\u00b3/h\", \"Efficiency (Assumed): 75%\"], \"notes\": \"Power calculated using P = (\u0394P * Q) / \u03b7. MoC 304L SS. Requires control valve for flow modulation.\"}, {\"id\": \"P-202\", \"name\": \"Reflux Pump\", \"service\": \"Return condensed water (4005) from V-201 back to C-201 top as reflux.\", \"type\": \"Centrifugal Pump\", \"streams_in\": [\"V-201\"], \"streams_out\": [\"4005\"], \"duty_or_load\": \"Power: 0.1 kW\", \"key_parameters\": [\"Differential Head: 0.5 bar\", \"Flow Rate: 4.6 m\u00b3/h\", \"Efficiency (Assumed): 75%\"], \"notes\": \"Power calculated using P = (\u0394P * Q) / \u03b7. Provides accurate flow control for reflux ratio.\"}, {\"id\": \"K-301\", \"name\": \"CO2 Compressor Train\", \"service\": \"Compress wet CO2 product to pipeline pressure (100 bara).\", \"type\": \"Multi-stage Centrifugal/Reciprocating\", \"streams_in\": [\"1007\", \"4003\"], \"streams_out\": [\"D-301\", \"4004\"], \"duty_or_load\": \"Total Power: 1.1 MW\", \"key_parameters\": [\"Inlet Pressure: 2.0 bara\", \"Outlet Pressure: 100 bara\", \"Stages: 3 to 5\"], \"notes\": \"Power estimated using a rule of thumb of 0.12 kWh/kg CO2 for 9167 kg/h flow. Includes intercoolers using CW.\"}, {\"id\": \"D-301\", \"name\": \"CO2 Drying Unit\", \"service\": \"Remove residual moisture from compressed CO2 to meet 50 ppmv water specification.\", \"type\": \"Adsorption Bed (e.g., Molecular Sieve)\", \"streams_in\": [\"K-301\"], \"streams_out\": [\"1008\"], \"duty_or_load\": \"Regeneration Duty: TBD\", \"key_parameters\": [\"Outlet Water Content: 50 ppmv\", \"Bed Cycle Time: TBD\"], \"notes\": \"Typically requires dual beds for continuous operation. Regeneration duty depends on cycle time and method (e.g., dry gas, steam). MoC 304L SS.\"}]}",
    "safety_risk_analyst_report": "{\"hazards\": [{\"title\": \"High Contaminant Inlet to Absorber\", \"severity\": 4, \"likelihood\": 3, \"risk_score\": 12, \"causes\": [\"Failure of V-101 pre-treatment scrubber\", \"Bypass of V-101 during maintenance\", \"Analyzer AT-1002 on stream 1002 fails low\"], \"consequences\": [\"Rapid, irreversible degradation of amine solvent in C-101 and C-201\", \"Increased corrosion rate in hot solvent loop (C-201, E-201, E-101)\", \"Loss of CO2 capture efficiency and high solvent replacement costs\"], \"mitigations\": [\"Install redundant SOx/particulate analyzers on stream 1002 with hard shutdown interlock for C-101 feed\", \"Specify corrosion-resistant 316L SS for high-temperature amine service\", \"Implement routine solvent quality monitoring program\"], \"notes\": [\"BoD specifies contaminant limit <5 ppmv; exceeding this is a major operability risk. Streams 1001 and 1002 are critical control points.\"]}, {\"title\": \"Loss of Regeneration Steam Supply\", \"severity\": 4, \"likelihood\": 3, \"risk_score\": 12, \"causes\": [\"Low-pressure steam (U-401) header failure\", \"Control valve on stream 4001 fails closed\", \"Reboiler E-201 tube leak or fouling causing shutdown\"], \"consequences\": [\"Stripper C-201 ceases to regenerate solvent, leading to loss of CO2 capture in C-101\", \"Vent gas (3001) CO2 concentration exceeds environmental limits\", \"Accumulation of rich amine and potential for process shutdown\"], \"mitigations\": [\"Install low-steam-flow alarm (FAL-4001) and low-reboiler-temperature alarm (TAL-201) with automated shutdown\", \"Specify E-201 with a 10% design margin and consider a standby reboiler for critical applications\"], \"notes\": [\"Reboiler duty is the largest energy consumer (21.7 MW); its failure directly impacts the primary process objective. Stream 4001 is a key utility input.\"]}, {\"title\": \"High Pressure in CO2 Compressor Circuit\", \"severity\": 5, \"likelihood\": 2, \"risk_score\": 10, \"causes\": [\"Compressor K-301 internal control system failure\", \"Downstream block valve inadvertently closed\", \"Failure of Pressure Safety Valve PSV-301 to open\", \"Loss of cooling water (4003) causing high interstage temperatures\"], \"consequences\": [\"Over-pressurization and potential catastrophic rupture of K-301, D-301, or associated piping\", \"Release of high-pressure CO2 posing an asphyxiation hazard to personnel\", \"Loss of CO2 product and damage to equipment\"], \"mitigations\": [\"Install high-pressure alarms (PAH-301) with automated compressor shutdown\", \"Ensure PSV-301 is correctly sized for maximum credible inlet flow and inspected per API 510\", \"Implement interlocks on critical block valves to prevent isolation\"], \"notes\": [\"Equipment downstream of K-301 is designed for 100 barg; this hazard targets the safety case for high-pressure equipment. Streams 1007 and 1008 are affected.\"]}, {\"title\": \"Loss of Solvent Circulation\", \"severity\": 4, \"likelihood\": 3, \"risk_score\": 12, \"causes\": [\"Pump P-101 (Rich Amine) or P-201 (Lean Amine) mechanical failure or power loss\", \"Blockage in Lean/Rich Heat Exchanger E-101\", \"Major solvent leak in the circulation loop\"], \"consequences\": [\"If P-201 fails, C-101 receives no lean amine and CO2 capture stops immediately\", \"If P-101 fails, C-101 saturates with CO2 and process performance degrades rapidly\", \"Potential for absorber or stripper flooding/foaming due to flow imbalance\"], \"mitigations\": [\"Provide 100% redundant pumps for P-101 and P-201 with automatic switchover\", \"Install low-flow alarms (FAL-101, FAL-201) on pump discharge streams 1004 and 2003\", \"Design E-101 with accessible cleaning-in-place (CIP) capabilities\"], \"notes\": [\"Solvent circulation is the circulatory system of the process. Failure of pumps P-101 or P-201 is a high-impact event. Streams 1003, 1004, 2002, 2003 are directly affected.\"]}, {\"title\": \"High Temperature in Amine Stripper\", \"severity\": 3, \"likelihood\": 3, \"risk_score\": 9, \"causes\": [\"Steam control valve to E-201 fails open\", \"Temperature controller TIC-201 fails high\", \"Loss of cooling water to E-101, causing high inlet temperature to C-201 on stream 1005\"], \"consequences\": [\"Accelerated thermal and oxidative degradation of amine solvent, increasing makeup costs\", \"Formation of corrosive heat-stable salts (HSS) in the solvent loop\", \"Increased amine vaporization losses with the overhead stream 1006\"], \"mitigations\": [\"Install high-temperature alarm (TAH-201) and independent high-high temperature trip (TIS-201) for C-201/E-201\", \"Implement advanced control strategies to manage reboiler duty based on lean loading\", \"Regularly monitor solvent for degradation products and HSS levels\"], \"notes\": [\"Operating at 110-120\u00b0C is a trade-off for regeneration; exceeding this significantly reduces solvent life. Key parameters for C-201 and E-201 are critical to monitor.\"]}], \"overall_assessment\": {\"risk_level\": \"High\", \"compliance_notes\": [\"Verify and finalize the specification, setpoints, and logic for all critical alarms and shutdowns mentioned (AT-1002, FAL-4001, TAL-201, PAH-301, TIS-201, etc.).\", \"Confirm the design basis and sizing calculation for Pressure Safety Valve PSV-301 on the CO2 compressor discharge.\", \"Develop a detailed inspection and testing plan for the redundant pumps (P-101, P-201) prior to commissioning.\", \"Finalize the solvent management plan, including the design of a reclamation unit to handle HSS and degradation products.\", \"Confirm Material of Construction (MoC) selection for all high-temperature and corrosive service (316L SS) is consistent with the final solvent choice.\"]}}",
    "project_manager_report": "## Executive Summary\n- Approval Status: Conditional\n- Key Rationale: Full approval is contingent upon the engineering verification and specification of critical safety systems and redundancy required to mitigate the high-impact risks identified in the HAZOP dossier.\n\n## Financial Outlook\n| Metric                       | Estimate |\n| ---------------------------- | -------- |\n| CAPEX (USD millions)         | 75       |\n| OPEX (USD millions per year) | 8.2      |\n| Contingency (%)              | 20       |\n\n## Implementation Plan\n1.  **Finalize Safety Instrumented Systems (SIS):** Develop and specify the logic, setpoints, and hardware for all critical alarms and shutdowns (e.g., AT-1002, FAL-4001, PAH-301) identified in the HAZOP to ensure solvent protection and high-pressure equipment safety (Owner: Lead Controls & Safety Engineer, Target: 4 weeks).\n2.  **Complete Detailed Equipment Specification:** Issue detailed datasheets for all major equipment, including specifying 100% redundant pumps for P-101 and P-201, finalizing the dual-bed design for D-301, and confirming the sizing basis for PSV-301 on the compressor discharge (Owner: Lead Mechanical Engineer, Target: 6 weeks).\n3.  **Perform Utility and Energy Integration Study:** Conduct a formal pinch analysis on the heat exchanger network (especially E-101) and re-evaluate the steam balance to identify and implement opportunities for OPEX reduction before final design freeze (Owner: Lead Process Engineer, Target: 8 weeks).\n\n## Final Notes\n- The financial estimates are based on the assumed 110 tonnes/day CO2 capture basis. Final CAPEX/OPEX will be sensitive to the final capacity required by the project.\n- The design basis assumes 90% CO2 recovery; any change to this target will significantly impact solvent circulation, equipment sizing, and utility consumption.\n- The regeneration duty and utility requirements for the CO2 Drying Unit (D-301) are listed as 'TBD' and must be defined to finalize utility balances and operating costs.\n- The HAZOP recommends 100% redundant pumps for solvent circulation (P-101, P-201); this must be incorporated into the final equipment list and CAPEX estimate.\n- A detailed solvent management plan, including the design basis for an Amine Reclamation unit, is required to manage long-term solvent degradation and waste streams (e.g., stream 3002)."
    }
    
    temp_data = {
        "problem_statement": "design heat exchanger to cool the ethanol product (99.5% purity molar basis) from 100 C to 40 C. Design flowrate of ethanol feed is 2500 kg/hr.",
        "requirements": "## Objective\n- Primary goal: Cool a stream of Ethanol product from an inlet temperature of 100\u00b0C to an outlet temperature of 40\u00b0C.\n- Key drivers: Not specified\n\n## Capacity\nThe design capacity for the heat exchanger duty calculation is based on the Ethanol mass flow rate: 2500.0 kg/hr.\n\n## Components\nThe chemical components involved in the process stream are:\n- Ethanol\n- Impurities (assumed to be minor components making up the balance to 100%)\n\n## Purity Target\n- Component: Ethanol\n- Value: 99.5% (Molar Basis)\n\n## Constraints & Assumptions\n- The process fluid (Ethanol product) inlet temperature is 100\u00b0C.\n- The process fluid (Ethanol product) outlet temperature is 40\u00b0C.\n- The mass flow rate of the Ethanol product stream is 2500 kg/hr.\n- The cooling medium (utility fluid) specifications (temperature, flow rate, type) are Not specified.\n- The required heat transfer duty (Q) is Not specified.\n- The target pressure for the process fluid is Not specified.",
        "research_concepts": "{\"concepts\": [{\"name\": \"Standard Fixed Tubesheet Heat Exchanger (Cooling Water Loop)\", \"maturity\": \"conventional\", \"description\": \"Utilizes a standard fixed tubesheet shell-and-tube heat exchanger. This design is robust, well-understood, and relies on the assumed availability of a standard cooling water utility loop for heat rejection.\", \"unit_operations\": [\"Feed Pump\", \"Fixed Tubesheet Shell-and-Tube Heat Exchanger\", \"Outlet Control Valve\"], \"key_benefits\": [\"High reliability and established maintenance procedures.\", \"Lower initial capital expenditure compared to specialized units.\", \"Simple process control strategy.\"]}, {\"name\": \"Spiral Heat Exchanger for High Fouling Potential\", \"maturity\": \"innovative\", \"description\": \"A spiral heat exchanger is selected to handle the stream, assuming the minor impurities might cause fouling. The design allows for highly turbulent flow and easier mechanical cleaning via water jetting or chemical circulation.\", \"unit_operations\": [\"Feed Pump\", \"Spiral Heat Exchanger\", \"Circulation Pump (for chemical cleaning)\", \"Strainers\"], \"key_benefits\": [\"Superior performance under potential fouling conditions compared to shell-and-tube.\", \"Compact footprint for the required duty.\", \"Ability to operate with a smaller approach temperature difference.\"]}, {\"name\": \"Integrated Heat Recovery with Organic Rankine Cycle (ORC)\", \"maturity\": \"state_of_the_art\", \"description\": \"Instead of rejecting the heat to a standard cooling tower, the 100\\u00b0C ethanol stream is used as the heat source to drive a small Organic Rankine Cycle (ORC) unit, generating useful electricity while cooling the ethanol stream to an intermediate temperature (e.g., 50\\u00b0C). A secondary cooler (air or cooling water) then brings it down to 40\\u00b0C.\", \"unit_operations\": [\"ORC Evaporator (Feed side)\", \"ORC Turbine/Generator\", \"Secondary Air-Cooled Heat Exchanger\", \"Feed Pump\"], \"key_benefits\": [\"Turns a cooling duty into an energy recovery opportunity (electricity generation).\", \"Significantly reduces operational energy costs.\", \"Reduces the load on conventional cooling utilities.\"]}, {\"name\": \"Two-Stage Cooling using Economizer and Cooling Water\", \"maturity\": \"innovative\", \"description\": \"A two-stage approach where the initial cooling from 100\\u00b0C to approximately 60\\u00b0C is achieved using a liquid-liquid plate heat exchanger against a cold return stream (if one exists, acting as an economizer), followed by a final cooling stage to 40\\u00b0C using the primary cooling water utility.\", \"unit_operations\": [\"Feed Pump\", \"Plate Heat Exchanger (Economizer Stage)\", \"Shell-and-Tube Heat Exchanger (Final Cooling Stage)\", \"Temperature Control Valve\"], \"key_benefits\": [\"Maximizes internal heat recovery before resorting to external utilities.\", \"Reduces the duty required from the cooling water loop, saving utility costs.\", \"Plate exchangers offer high efficiency for the initial temperature drop.\"]}]}",
        "selected_concept_name": "Standard Fixed Tubesheet Heat Exchanger (Cooling Water Loop)",
        "selected_concept_details": "## Concept Selection: Standard Fixed Tubesheet Heat Exchanger (Cooling Water Loop)\n\nThe **Standard Fixed Tubesheet Heat Exchanger (Cooling Water Loop)** is selected as the baseline design due to its conventional nature, high reliability, and lower initial capital expenditure, aligning with the general preference for established technology when key utility specifications are unknown.\n\n## Process Narrative\n\nThe 99.5% molar basis Ethanol product stream, entering at 100\u00b0C, is pressurized by the Feed Pump (P-101) to overcome the pressure drop across the heat exchanger and associated piping, targeting a nominal operating pressure of TBD barg. This hot stream flows through the shell side of the Fixed Tubesheet Shell-and-Tube Heat Exchanger (E-101). Simultaneously, the cooling utility fluid (assumed to be cooling water) is supplied from the plant utility header and flows through the tube side of E-101. Heat is transferred from the hot ethanol to the cooler utility fluid, reducing the ethanol temperature to the target of 40\u00b0C.\n\nThe cooled ethanol exits E-101 and passes through an Outlet Control Valve (CV-101) to regulate the downstream pressure and flow rate, ensuring stable operation of the entire cooling system and preventing thermal shock to downstream equipment. The utility fluid, now warmed, is returned to the plant's cooling water system for re-cooling. The simplicity of this design relies heavily on the utility fluid being chemically compatible and thermally stable enough to manage the required heat load without causing excessive fouling or thermal stress on the fixed tube bundle.\n\n## Major Equipment & Roles\n\n| Equipment | Function | Critical Operating Notes |\n| :--- | :--- | :--- |\n| P-101 Feed Pump | Provide necessary head to move the ethanol stream through the exchanger and control flow. | Must be sized based on the calculated duty and required pressure drop (TBD). Duty/Standby configuration recommended for reliability. |\n| E-101 Fixed Tubesheet Exchanger | Reject the required heat load ($Q_{design}$) from the ethanol stream using the cooling utility. | Material selection (e.g., Carbon Steel or Stainless Steel) must be confirmed based on utility water chemistry. Fixed design requires careful thermal stress analysis. |\n| CV-101 Outlet Control Valve | Regulate the outlet flow and pressure of the cooled ethanol product stream. | Sized for turndown capability (TBD) and must handle the process fluid at 40\u00b0C. |\n\n## Operating Envelope\n\n| Parameter | Ethanol Process Stream | Cooling Utility Stream |\n| :--- | :--- | :--- |\n| Design Capacity (Flow) | 2500.0 kg/hr | TBD kg/hr |\n| Inlet Temperature | 100\u00b0C | TBD (\u00b0C) |\n| Outlet Temperature | 40\u00b0C | TBD (\u00b0C) |\n| Design Pressure | TBD barg (Target: Moderate Pressure) | TBD barg (Based on Utility Header) |\n| Purity | 99.5% Molar | N/A |\n\n**Special Utilities Required:** Cooling Water Utility (Specification pending).\n\n## Risks & Safeguards\n\n| Process Risk | Consequence | Safeguard / Mitigation Strategy |\n| :--- | :--- | :--- |\n| **Thermal Stress Failure** | Tube-to-tubesheet joint failure due to large $\\Delta T$ between shell and tube sides. | **Safeguard:** Specify a U-tube or floating head design if the utility $\\Delta T$ exceeds 30\u00b0C, overriding the initial CAPEX preference for fixed tubesheet. |\n| **Excessive Fouling** | Heat transfer coefficient drops below design minimum, leading to ethanol outlet temperature $> 40^\\circ\\text{C}$. | **Safeguard:** Design the exchanger with a 25% contingency on the required heat transfer area. Implement a routine monitoring strategy based on differential pressure across the exchanger. |\n| **Tube Leak / Cross-Contamination** | Ethanol leaks into the cooling water loop, creating a fire/environmental hazard in the utility system. | **Safeguard:** Specify a double tube sheet design if the cooling water is non-contact or critical (e.g., potable water). Implement conductivity monitoring on the cooling water return line. |\n| **Loss of Cooling Utility** | Ethanol outlet temperature spikes above 40\u00b0C, potentially damaging downstream equipment or storage integrity. | **Safeguard:** Install a High-Temperature Alarm (ATH) on the ethanol outlet line, tied to an automatic shutdown (ESD) of the Feed Pump (P-101) if the temperature exceeds $45^\\circ\\text{C}$. |\n\n## Data Gaps & Assumptions\n\nThe following critical data points must be resolved during the Front-End Engineering Design (FEED) phase:\n\n1.  **Utility Specifications:** The temperature profile (min/max inlet/outlet) and flow rate of the cooling water utility are **TBD**. This is the single most critical input for sizing E-101.\n2.  **Process Pressure:** The required operating pressure for the ethanol stream is **TBD**. This dictates pump selection (P-101) and valve sizing (CV-101).\n3.  **Heat Duty ($Q$):** The required heat duty must be calculated using the specific heat capacity ($C_p$) of the 99.5% ethanol stream at the operating temperatures. The $C_p$ value is **TBD** and must be confirmed via thermodynamic property software or lab data.\n4.  **Fouling Factor:** The expected fouling resistance ($R_f$) for the ethanol stream is **TBD**. This will determine the necessary surface area contingency.\n5.  **Material Compatibility:** Final material selection for E-101 is **TBD**, pending confirmation of cooling water chemistry and ethanol corrosivity.",
        "design_basis": "# Preliminary Process Basis of Design (BoD) - Heat Exchanger Unit\n\n## 1. Project Overview and Problem Statement\nThis document establishes the preliminary basis for the design of a dedicated heat exchanger unit responsible for cooling a high-purity Ethanol product stream. The primary objective is to reduce the temperature of the 99.5% molar basis Ethanol stream from an inlet temperature of $100^\\circ\\text{C}$ to a target outlet temperature of $40^\\circ\\text{C}$, utilizing a cooling utility fluid. The selected baseline technology is a Standard Fixed Tubesheet Shell-and-Tube Heat Exchanger (E-101) utilizing a Cooling Water Loop.\n\n## 2. Key Design Assumptions and Exclusions\n*   **Design Basis:** The design is based on the specified mass flow rate of $2500.0 \\text{ kg/hr}$ of Ethanol product.\n*   **Process Technology:** A Fixed Tubesheet Shell-and-Tube Heat Exchanger (E-101) is the preliminary selection. This selection is subject to revision if the required utility $\\Delta T$ necessitates a floating head or U-tube design to manage thermal expansion.\n*   **Cooling Utility:** The cooling medium is assumed to be standard plant Cooling Water (CW). Specific CW temperature profiles and flow rates are **TBD**.\n*   **Operating Hours:** Continuous operation (8,760 hours/year) is assumed for duty calculation purposes.\n*   **Purity Basis:** All thermal calculations will use the properties of 99.5% molar Ethanol, with the minor impurities assumed to have negligible impact on the overall specific heat capacity ($C_p$) for preliminary sizing.\n*   **Exclusions:** Detailed mechanical design, final pressure drop calculations, specific pump sizing (P-101), and final material selection are excluded from this preliminary BoD.\n\n## 3. Design Capacity and Operating Conditions\n\n### Process Stream (Hot Side - Ethanol)\n| Parameter | Value | Units | Basis |\n| :--- | :--- | :--- | :--- |\n| **Design Mass Flow Rate** | 2,500.0 | kg/hr | User Requirement |\n| **Inlet Temperature ($T_{in}$)** | 100 | ${}^\\circ\\text{C}$ | User Requirement |\n| **Outlet Temperature ($T_{out}$)** | 40 | ${}^\\circ\\text{C}$ | User Requirement |\n| **Target Purity** | 99.5 | Molar % | User Requirement |\n| **Design Pressure ($P_{design}$)** | TBD (Assumed Moderate) | barg | Preliminary Estimate |\n| **Required Heat Duty ($Q_{req}$)** | TBD | kW | Requires $C_p$ confirmation |\n\n### Cooling Utility Stream (Cold Side - Cooling Water)\n| Parameter | Value | Units | Basis |\n| :--- | :--- | :--- | :--- |\n| **Design Mass Flow Rate** | TBD | kg/hr | Calculated based on $Q_{req}$ and $\\Delta T_{CW}$ |\n| **Inlet Temperature ($T_{in}$)** | TBD | ${}^\\circ\\text{C}$ | Utility Specification Pending |\n| **Outlet Temperature ($T_{out}$)** | TBD | ${}^\\circ\\text{C}$ | Utility Specification Pending |\n| **Design Pressure ($P_{design}$)** | TBD | barg | Utility Header Pressure |\n\n## 4. Chemical Components\n\n| Name | Formula | MW | Role |\n| :--- | :--- | :--- | :--- |\n| Ethanol | $\\text{C}_2\\text{H}_5\\text{OH}$ | 46.07 | Primary Process Fluid |\n| Water | $\\text{H}_2\\text{O}$ | 18.015 | Assumed Cooling Utility Component |\n\n## 5. Feed and Product Specifications\n\n### Process Fluid (Inlet Stream)\n*   **Composition:** 99.5% Molar Ethanol.\n*   **Inlet Temperature:** $100^\\circ\\text{C}$.\n\n### Process Fluid (Outlet Stream)\n*   **Composition:** 99.5% Molar Ethanol.\n*   **Outlet Temperature:** $40^\\circ\\text{C}$.\n*   **Pressure:** To be determined based on downstream pressure requirements and calculated pressure drop.\n\n## 6. Preliminary Utility Summary\n*   **Primary Utility:** Cooling Water (CW). Specifications (flow, temperature) are **TBD**.\n*   **Secondary Utility:** Electricity required for Feed Pump (P-101).\n*   **Instrument Air:** Required for Control Valve (CV-101) operation.\n\n## 7. Environmental and Regulatory Criteria\n*   **Containment:** The design must ensure zero cross-contamination between the high-purity Ethanol product and the cooling water utility.\n*   **Fire Safety:** As Ethanol is flammable, the heat exchanger area must comply with relevant area classification standards (e.g., NEC/IEC) for flammable liquid handling.\n*   **Wastewater:** The cooling water return stream must be managed according to site discharge limits, though this is typically handled by the central utility system.\n\n## 8. Process Selection Rationale (High-Level)\nThe **Fixed Tubesheet Shell-and-Tube Exchanger** is selected for its simplicity and low initial cost, suitable for preliminary design where utility conditions are not yet finalized. The primary risk associated with this design (thermal expansion) must be mitigated by ensuring the utility $\\Delta T$ is manageable or by upgrading the design to a floating head configuration during FEED if necessary. The process narrative involves pressurizing the hot stream via P-101 to ensure positive flow through the exchanger, followed by pressure let-down via CV-101 downstream.\n\n## 9. Preliminary Material of Construction (MoC) Basis\n*   **Ethanol Side (Shell/Tubes):** Stainless Steel (e.g., 304L or 316L) is recommended due to the presence of high-purity Ethanol, which can be mildly corrosive, and to prevent contamination of the product.\n*   **Cooling Water Side (Shell/Tubes):** Carbon Steel (CS) may be acceptable if the cooling water is non-aggressive (low chloride/low acidity). Final selection depends on CW chemistry analysis.\n*   **Gaskets/Seals:** PTFE or equivalent chemical-resistant material is required for all process connections.\n\n## 10. Data Gaps and Critical Path Items\nThe following items are critical and must be resolved before detailed design (FEED) can commence:\n\n1.  **Specific Heat Capacity ($C_p$):** Accurate $C_p$ data for 99.5% molar Ethanol at the operating temperature range ($40^\\circ\\text{C}$ to $100^\\circ\\text{C}$) is required to calculate the definitive Heat Duty ($Q$).\n2.  **Cooling Water Specifications:** Inlet/Outlet temperatures and flow rate of the cooling utility are mandatory inputs.\n3.  **Pressure Drop Requirements:** The maximum allowable pressure drop across E-101 for both the shell and tube sides must be defined to properly size P-101 and CV-101.\n4.  **Fouling Factor ($R_f$):** A design fouling factor must be established to determine the required heat transfer area contingency.",
        "basic_pfd": "## Flowsheet Summary\n- Concept: Ethanol Cooling Skid (Fixed Tubesheet)\n- Objective: Reduce hot ethanol from 100\u00b0C to 40\u00b0C using an unspecified cooling utility (assumed Cooling Water).\n- Key Drivers: Establishing the baseline design based on known flow and temperature targets.\n\n## Units\n| ID    | Name                | Type                       | Description                                    |\n| :--- | :--- | :--- | :--- |\n| P-101 | Feed Pump           | Centrifugal pump           | Pressurizes hot ethanol feed to overcome exchanger pressure drop. |\n| E-101 | Ethanol Cooler      | Fixed Tubesheet Exchanger | Shell-and-tube unit rejecting heat from ethanol to cooling water. |\n| CV-101 | Outlet Control Valve | Control Valve              | Regulates downstream pressure and flow of cooled ethanol product. |\n| U-201 | Cooling Water Loop  | Utility Header             | Provides cooling utility supply and receives the warmed return stream. |\n\n## Streams\n| ID   | Stream             | From             | To           | Description                                    |\n| :--- | :--- | :--- | :--- | :--- |\n| 1001 | Hot Ethanol Feed   | Upstream Source  | P-101        | Process ethanol at 100\u00b0C, 2500 kg/hr. Pressure TBD. |\n| 1002 | Pressurized Ethanol| P-101            | E-101 (Shell) | Ethanol stream pressurized to overcome $\\Delta P$. |\n| 1003 | Cooled Ethanol     | E-101 (Shell)    | CV-101       | Product leaving exchanger at target 40\u00b0C. |\n| 1004 | Product Outlet     | CV-101           | Downstream Unit| Regulated flow of 40\u00b0C ethanol product. |\n| 2001 | CW Supply          | U-201            | E-101 (Tube) | Cooling Water enters exchanger at TBD temperature. |\n| 2002 | CW Return          | E-101 (Tube)     | U-201        | Warmed cooling water returns to utility system. |\n\n## Overall Description\nThe process begins with the hot Ethanol Feed (Stream 1001) being pressurized by the Feed Pump (P-101) to create Stream 1002, which enters the shell side of the Fixed Tubesheet Heat Exchanger (E-101). The cooling utility (Stream 2001) enters the tube side of E-101. Heat is rejected from the ethanol to the utility fluid, resulting in the cooled ethanol product (Stream 1003) at $40^\\circ\\text{C}$. This stream passes through the Outlet Control Valve (CV-101) to establish the final regulated flow (Stream 1004). The warmed utility fluid (Stream 2002) is returned to the Cooling Water Loop (U-201).\n\n## Notes\n- **Critical Data Gap:** The required heat duty ($Q$) cannot be calculated without the specific heat capacity ($C_p$) of 99.5% Ethanol. This must be resolved in FEED.\n- **Innovation Note:** While the baseline is a Fixed Tubesheet design, the high inlet temperature ($100^\\circ\\text{C}$) relative to the outlet ($40^\\circ\\text{C}$) suggests a significant temperature differential ($\\Delta T$) between the shell and tube sides is likely. Downstream mechanical design **must** confirm if a Floating Head or U-Tube design is required to prevent thermal stress failure in E-101.\n- **Instrumentation Note:** A High-Temperature Alarm (ATH) should be installed on Stream 1003, interlocked to trip P-101 if the temperature exceeds $45^\\circ\\text{C}$ due to loss of cooling utility.",
        "equipment_and_stream_list": "{\"equipments\": [{\"id\": \"P-101\", \"name\": \"Feed Pump\", \"description\": \"Pressurizes hot ethanol feed to overcome exchanger pressure drop.\", \"service\": \"Feed pressurization for E-101.\", \"type\": \"Centrifugal pump\", \"category\": \"Pump\", \"streams_in\": [\"1001\"], \"stream_out\": \"1002\", \"design_criteria\": \"Must provide sufficient head to overcome E-101 $\\\\Delta P$ and CV-101 pressure drop.\", \"sizing_parameters\": [{\"name\": \"Required Head\", \"quantity\": {\"value\": \"000\", \"unit\": \"m\"}}, {\"name\": \"Required Flow\", \"quantity\": {\"value\": 2500.0, \"unit\": \"kg/hr\"}}], \"notes\": \"Sizing depends on TBD pressure drop requirements across E-101 and CV-101.\"}, {\"id\": \"E-101\", \"name\": \"Ethanol Cooler\", \"description\": \"Shell-and-tube unit rejecting heat from ethanol to cooling water.\", \"service\": \"Cooling 99.5% Ethanol from 100\u00b0C to 40\u00b0C.\", \"type\": \"Fixed Tubesheet Exchanger\", \"category\": \"Heat Exchanger\", \"streams_in\": [\"1002\", \"2001\"], \"stream_out\": \"1003\", \"design_criteria\": \"Achieve $Q_{req}$ with specified approach temperature.\", \"sizing_parameters\": [{\"name\": \"Heat Duty (Q)\", \"quantity\": {\"value\": \"000\", \"unit\": \"kW\"}}, {\"name\": \"Area\", \"quantity\": {\"value\": \"000\", \"unit\": \"m\u00b2\"}}, {\"name\": \"Overall U\", \"quantity\": {\"value\": \"000\", \"unit\": \"W/m\u00b2-K\"}}], \"notes\": \"Preliminary selection is Fixed Tubesheet. Mechanical design must confirm if U-tube or Floating Head is required to manage thermal stress ($\\\\Delta T$). Shell side: Ethanol; Tube side: Cooling Water.\"}, {\"id\": \"CV-101\", \"name\": \"Outlet Control Valve\", \"description\": \"Regulates downstream pressure and flow of cooled ethanol product.\", \"service\": \"Flow/Pressure Control of Cooled Ethanol.\", \"type\": \"Control Valve\", \"category\": \"Control Valve\", \"streams_in\": [\"1003\"], \"stream_out\": \"1004\", \"design_criteria\": \"Must handle 40\u00b0C Ethanol and provide required pressure let-down.\", \"sizing_parameters\": [{\"name\": \"Cv (Inlet)\", \"quantity\": {\"value\": \"000\", \"unit\": \"m\u00b3/h\"}}], \"notes\": \"Sizing depends on TBD downstream pressure requirements.\"}, {\"id\": \"U-201\", \"name\": \"Cooling Water Loop\", \"description\": \"Utility Header providing cooling utility supply and receiving the warmed return stream.\", \"service\": \"Utility Distribution/Collection\", \"type\": \"Utility Header\", \"category\": \"Utility System\", \"streams_in\": [\"2002\"], \"stream_out\": \"2001\", \"design_criteria\": \"Must maintain specified supply pressure and temperature for E-101.\", \"sizing_parameters\": [], \"notes\": \"Specifications (flow, T_in, P_in) are TBD.\"}], \"streams\": [{\"id\": \"1001\", \"name\": \"Hot Ethanol Feed\", \"description\": \"Process ethanol at 100\u00b0C, 2500 kg/hr, entering the system.\", \"from\": \"Upstream Source\", \"to\": \"P-101\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": {\"value\": 2500.0, \"unit\": \"kg/hr\"}, \"temperature\": {\"value\": 100.0, \"unit\": \"\u00b0C\"}, \"pressure\": {\"value\": \"000\", \"unit\": \"barg\"}}, \"compositions\": {\"Ethanol\": {\"value\": 0.995, \"unit\": \"molar fraction\"}, \"Impurities\": {\"value\": 0.005, \"unit\": \"molar fraction\"}}, \"notes\": \"Inlet pressure is TBD.\"}, {\"id\": \"1002\", \"name\": \"Pressurized Ethanol\", \"description\": \"Ethanol stream pressurized by P-101 to overcome $\\\\Delta P$ across E-101.\", \"from\": \"P-101\", \"to\": \"E-101 (Shell)\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": {\"value\": 2500.0, \"unit\": \"kg/hr\"}, \"temperature\": {\"value\": 100.0, \"unit\": \"\u00b0C\"}, \"pressure\": {\"value\": \"000\", \"unit\": \"barg\"}}, \"compositions\": {\"Ethanol\": {\"value\": 0.995, \"unit\": \"molar fraction\"}, \"Impurities\": {\"value\": 0.005, \"unit\": \"molar fraction\"}}, \"notes\": \"Discharge pressure from P-101 is TBD based on required pressure drop.\"}, {\"id\": \"1003\", \"name\": \"Cooled Ethanol\", \"description\": \"Product leaving exchanger E-101 shell side at target 40\u00b0C.\", \"from\": \"E-101 (Shell)\", \"to\": \"CV-101\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": {\"value\": 2500.0, \"unit\": \"kg/hr\"}, \"temperature\": {\"value\": 40.0, \"unit\": \"\u00b0C\"}, \"pressure\": {\"value\": \"000\", \"unit\": \"barg\"}}, \"compositions\": {\"Ethanol\": {\"value\": 0.995, \"unit\": \"molar fraction\"}, \"Impurities\": {\"value\": 0.005, \"unit\": \"molar fraction\"}}, \"notes\": \"High-Temperature Alarm (ATH) required on this stream, interlocked to trip P-101 if T > 45\u00b0C.\"}, {\"id\": \"1004\", \"name\": \"Product Outlet\", \"description\": \"Regulated flow of 40\u00b0C ethanol product leaving the skid.\", \"from\": \"CV-101\", \"to\": \"Downstream Unit\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": {\"value\": 2500.0, \"unit\": \"kg/hr\"}, \"temperature\": {\"value\": 40.0, \"unit\": \"\u00b0C\"}, \"pressure\": {\"value\": \"000\", \"unit\": \"barg\"}}, \"compositions\": {\"Ethanol\": {\"value\": 0.995, \"unit\": \"molar fraction\"}, \"Impurities\": {\"value\": 0.005, \"unit\": \"molar fraction\"}}, \"notes\": \"Final regulated pressure is TBD.\"}, {\"id\": \"2001\", \"name\": \"CW Supply\", \"description\": \"Cooling Water enters exchanger E-101 tube side.\", \"from\": \"U-201\", \"to\": \"E-101 (Tube)\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": {\"value\": \"000\", \"unit\": \"kg/hr\"}, \"temperature\": {\"value\": \"000\", \"unit\": \"\u00b0C\"}, \"pressure\": {\"value\": \"000\", \"unit\": \"barg\"}}, \"compositions\": {\"Water\": {\"value\": 1.0, \"unit\": \"molar fraction\"}}, \"notes\": \"Flow rate, inlet temperature, and pressure are TBD based on required duty. Assumed 100% Water for utility stream.\"}, {\"id\": \"2002\", \"name\": \"CW Return\", \"description\": \"Warmed cooling water returns from E-101 tube side to utility system.\", \"from\": \"E-101 (Tube)\", \"to\": \"U-201\", \"phase\": \"Liquid\", \"properties\": {\"mass_flow\": {\"value\": \"000\", \"unit\": \"kg/hr\"}, \"temperature\": {\"value\": \"000\", \"unit\": \"\u00b0C\"}, \"pressure\": {\"value\": \"000\", \"unit\": \"barg\"}}, \"compositions\": {\"Water\": {\"value\": 1.0, \"unit\": \"molar fraction\"}}, \"notes\": \"Outlet temperature is dependent on the unknown heat duty (Q). Assumed 100% Water.\"}]}",
        "safety_risk_analyst_report": "{\"hazards\": [{\"title\": \"Loss of Cooling Utility Flow (Stream 2001)\", \"severity\": 4, \"likelihood\": 3, \"risk_score\": 12, \"causes\": [\"Failure of CW pump in U-201\", \"Isolation valve XV-201 fails closed\", \"Blockage in CW supply header (U-201)\"], \"consequences\": [\"Ethanol outlet temperature (Stream 1003) rises above 45\\u00b0C (Safety Limit).\", \"Potential for thermal degradation of Ethanol product.\", \"Downstream equipment rated for 40\\u00b0C may experience thermal stress.\"], \"mitigations\": [\"Install High-Temperature Alarm (ATH) on Stream 1003, interlocked to trip Feed Pump (P-101).\", \"Install flow switch (FSH) on Stream 2001, interlocked to trip P-101.\", \"Ensure CW pumps (U-201) are configured with automatic changeover to standby units.\"], \"notes\": [\"This is the primary process safety risk due to the high inlet temperature (100\\u00b0C) and the critical cooling requirement.\", \"The required $C_p$ data is needed to calculate the exact temperature rise rate.\"]}, {\"title\": \"Excessive Thermal Stress on E-101 Fixed Tubesheet\", \"severity\": 4, \"likelihood\": 2, \"risk_score\": 8, \"causes\": [\"Cooling Water Inlet Temperature (Stream 2001) is significantly lower than assumed design basis.\", \"High LMTD resulting from low CW flow rate.\", \"Failure to upgrade design from Fixed Tubesheet to Floating Head/U-Tube.\"], \"consequences\": [\"Catastrophic failure of tube-to-tubesheet welds leading to immediate loss of containment.\", \"Cross-contamination of high-purity Ethanol (Stream 1003) with Cooling Water (Stream 2002).\"], \"mitigations\": [\"Mechanical design must confirm the maximum allowable $\\\\Delta T$ between shell and tube sides.\", \"If $\\\\Delta T$ exceeds limits, mandate design upgrade to Floating Head or U-Tube configuration.\", \"Implement rigorous inspection schedule for tube bundle welds.\"], \"notes\": [\"The fixed tubesheet selection is a preliminary cost-saving measure that introduces a high mechanical risk.\", \"Requires confirmation of CW temperature specifications (TBD).\"]}, {\"title\": \"High Pressure on Ethanol Feed Side (Stream 1002)\", \"severity\": 3, \"likelihood\": 3, \"risk_score\": 9, \"causes\": [\"E-101 Tube Side (Stream 2001) pressure surge due to utility header upset.\", \"CV-101 fails fully closed, causing immediate backpressure on E-101 shell side.\", \"P-101 over-pressurization due to control failure.\"], \"consequences\": [\"Failure of E-101 shell or associated piping/flanges.\", \"Potential rupture of the fixed tubesheet joints.\"], \"mitigations\": [\"Install a Pressure Safety Valve (PSV) on the shell side of E-101, sized for the maximum discharge pressure of P-101.\", \"Ensure CV-101 has reliable pressure control instrumentation (PIC/PSV backup).\", \"Verify P-101 motor trip logic based on discharge pressure (PSH).\"], \"notes\": [\"Design pressure for E-101 and associated piping is currently TBD.\", \"The PSV set point must be below the lowest rated component pressure (E-101 shell or P-101 casing).\"]}, {\"title\": \"Product Contamination (Impurity Carryover)\", \"severity\": 2, \"likelihood\": 2, \"risk_score\": 4, \"causes\": [\"Inadequate purity of inlet stream (Stream 1001) exceeding 99.5% molar.\", \"Phase separation or flashing within E-101 due to unexpected low pressure.\", \"Failure of gaskets/seals in E-101 or CV-101.\"], \"consequences\": [\"Off-spec final product (Stream 1004) requiring reprocessing or disposal.\", \"Potential downstream catalyst poisoning if impurities are reactive.\"], \"mitigations\": [\"Install online purity analyzer on Stream 1004 with high-level alarm (AHL) interlocked to divert flow.\", \"Ensure all wetted parts of E-101 and CV-101 are Stainless Steel (as recommended) to minimize corrosion/leaching.\", \"Confirm operating pressure profile ensures liquid phase throughout E-101.\"], \"notes\": [\"The nature of the 0.5% impurities is unknown, impacting corrosion and fouling risk.\", \"This is primarily a quality/economic risk unless impurities are highly hazardous.\"]}], \"overall_assessment\": {\"risk_level\": \"Medium\", \"compliance_notes\": [\"Critical Data Gap: Finalize $C_p$ for 99.5% Ethanol to calculate definitive Heat Duty ($Q$).\", \"Critical Data Gap: Define Cooling Water (CW) inlet/outlet temperatures and flow rates to confirm exchanger type (Fixed vs. Floating Head).\", \"Ensure PSV sizing for E-101 shell side is completed based on P-101 maximum discharge pressure.\", \"Verify area classification requirements due to the presence of flammable Ethanol.\"]}}",
        "project_manager_report": "## Executive Summary\n- Approval Status: Conditional\n- Key Rationale: The conceptual design is sound, but advancement to FEED is conditional upon resolving critical data gaps regarding the specific heat capacity of the product and the specifications of the cooling utility, which directly impact the mechanical design of the critical heat exchanger (E-101).\n\n## Financial Outlook\n| Metric                       | Estimate |\n| ---------------------------- | -------- |\n| CAPEX (USD millions)         | 0.85     |\n| OPEX (USD millions per year) | 0.15     |\n| Contingency (%)              | 20       |\n\n## Implementation Plan\n1.  **Resolve Critical Data Gaps (Owner: Process Engineering):** Immediately initiate procurement of thermodynamic data for 99.5% Ethanol ($C_p$) and secure firm specifications (T_in, Flow) for the Cooling Water Utility (Stream 2001). (Target: 3 weeks)\n2.  **Finalize E-101 Mechanical Design Basis (Owner: Mechanical Engineering):** Based on confirmed $C_p$ and utility data, finalize the required heat duty ($Q$) and determine definitively whether the Fixed Tubesheet design for E-101 is acceptable or if a Floating Head/U-Tube design must be adopted to manage thermal expansion risk.\n3.  **Complete Safety Review & Sizing (Owner: Safety/Piping):** Finalize the maximum discharge pressure for P-101 and size the required Pressure Safety Valve (PSV) on the shell side of E-101, ensuring compliance with Hazard ID #3.\n\n## Final Notes\n- The preliminary CAPEX estimate ($0.85M) assumes the baseline Fixed Tubesheet design for E-101 is confirmed in Step 2. If a Floating Head design is required, CAPEX is estimated to increase by 25-35%.\n- The unknown nature of the 0.5% impurities in Stream 1001 requires a conservative fouling factor ($R_f$) of $0.0004 \\text{ m}^2\\text{K/W}$ to be used in the FEED heat transfer calculations until further analysis is complete.\n- Area classification review must be completed for the skid area due to the flammability of Ethanol."
    }
    
    return temp_data

config = DEFAULT_CONFIG.copy()
config["llm_provider"] = "openrouter"
config["quick_think_llm"] = "openai/gpt-5-nano"
config["deep_think_llm"] = "openai/gpt-5-nano"

def main():
    if config["llm_provider"].lower() == "openrouter":
        base_url = "https://openrouter.ai/api/v1"
        api_key = os.getenv("OPENROUTER_API_KEY")
        deep_thinking_llm = ChatOpenAI(model=config["deep_think_llm"], base_url=base_url, api_key=api_key)
        quick_thinking_llm = ChatOpenAI(model=config["quick_think_llm"], base_url=base_url, api_key=api_key)

        quick_thinking_llm.temperature = 0.5
        deep_thinking_llm.temperature = 0.5
        
        # Load example data
        with open("eval_results/ProcessDesignAgents_logs/full_states_log.json", "r") as f:
            temp_data = json.load(f)
        
        # temp_data: Dict[str, Any]= json.load("eval_results/ProcessDesignAgents_logs/full_states_log.json")
        requirement_md = temp_data.get("requirements", "")
        design_basis_md = temp_data.get("design_basis", "")
        basic_pfd_md = temp_data.get("basic_pfd", "")
        equipment_stream_list_str = temp_data.get("equipment_and_stream_list", "")
        
        # Adapt agent_state
        state = create_design_state(
            requirements=requirement_md,
            design_basis=design_basis_md,
            basic_pfd=basic_pfd_md,
            equipment_and_stream_list=equipment_stream_list_str,
        )
        
        equipment_category_set = set()  # define as set
        equipment_stream_list_dict = json.loads(equipment_stream_list_str)
        
        if "equipments" in equipment_stream_list_dict:
            # Get the equipment list from master dict
            equipment_list = equipment_stream_list_dict["equipments"]
            
            # Loop throught equipment list
            for eq in equipment_list:
                equipment_category_set.add(eq.get("category", ""))
                
            equipment_category_names = list(equipment_category_set)
            
            print(equipment_category_names)
            
            equipment_category = [
                {
                    "name": name,
                    "ids": [eq.get("id", "") for eq in equipment_list if eq.get("category", "") == name]
                }
                for name in equipment_category_names
            ]
            
            for cat in equipment_category:
                print(cat)
        else:
            raise ValueError("Equipments not found")
        
        # Tools
        tools_list = [
            size_heat_exchanger_basic,
            size_pump_basic
        ]
        
        master_equipment_list_json = json.loads(equipment_stream_list_str)
        
        for category_name in ["Heat Exchanger", "Pump"]:
            master_equipment_list_json = size_equipment_by_category(
                category_name=category_name,
                equipment_stream_list_dict=master_equipment_list_json,
                state=state,
                deep_thinking_llm=deep_thinking_llm,
                quick_thinking_llm=quick_thinking_llm,
                equipment_category=equipment_category,
                tools_list=tools_list,
            )
        
        # print(master_equipment_list_json)
        combined_md, equipment_md, streams_md = equipments_and_streams_dict_to_markdown(master_equipment_list_json)
        print(equipment_md)
        

def size_equipment_by_category(
    category_name: str,
    equipment_stream_list_dict: Dict[str, Any],
    state: Dict[str, Any],
    deep_thinking_llm: ChatOpenAI,
    quick_thinking_llm: ChatOpenAI,
    equipment_category: List[Dict[str, Any]],
    tools_list: List[Any],
) -> Dict[str, Any]:
    # Select Heat Exchanger Category for process
    if not "equipments" in equipment_stream_list_dict:
        raise ValueError("Equipments not found")
    else:
        equipment_list = equipment_stream_list_dict["equipments"]

    if not "streams" in equipment_stream_list_dict:
        raise ValueError("Streams not found")
    else:
        stream_list = equipment_stream_list_dict["streams"]

    equipment_category = next((cat for cat in equipment_category if cat.get("name", "") == category_name), None)
    
    if not equipment_category:
        print(f"{category_name} Category not found")
    else:
        equipment_ids = equipment_category.get("ids", [])
        print(f"DEBUG: {category_name} IDs: {equipment_ids}")

        tool_map = {tool.name: tool for tool in tools_list}

        base_llm_with_tools = quick_thinking_llm.bind_tools(tools_list)
        structured_enabled = True
        try:
            llm_with_tools = base_llm_with_tools.with_structured_output(
                method="json_mode",
                include_raw=True,
            )
        except (AttributeError, TypeError, ValueError, NotImplementedError):
            llm_with_tools = base_llm_with_tools
            structured_enabled = False

        def unpack_structured_result(
            output: Any,
        ) -> Tuple[BaseMessage, Optional[Any], Optional[BaseException]]:
            if isinstance(output, dict):
                raw_msg = output.get("raw")
                parsed_payload = output.get("parsed")
                parsing_error = output.get("parsing_error")
                if raw_msg is None:
                    if parsed_payload is not None:
                        if isinstance(parsed_payload, (dict, list)):
                            try:
                                raw_content = json.dumps(parsed_payload)
                            except (TypeError, ValueError):
                                raw_content = str(parsed_payload)
                        else:
                            raw_content = str(parsed_payload)
                    else:
                        raw_content = ""
                    raw_msg = AIMessage(content=raw_content)
                return raw_msg, parsed_payload, parsing_error
            if isinstance(output, BaseMessage):
                return output, None, None
            raise TypeError(
                f"Unexpected output type from llm_with_tools: {type(output)}"
            )

        def is_structured_mode_provider_error(error: Exception) -> bool:
            if not isinstance(error, ValueError):
                return False
            if not error.args:
                return False
            payload = error.args[0]
            if isinstance(payload, dict):
                code = payload.get("code")
                metadata = payload.get("metadata")
                provider = metadata.get("provider_name") if isinstance(metadata, dict) else None
                return code == 502 or provider == "Google AI Studio"
            if isinstance(payload, str):
                return "Provider returned error" in payload and "502" in payload
            return False

        def safe_invoke(messages: List[BaseMessage]) -> Any:
            nonlocal llm_with_tools, structured_enabled
            try:
                return llm_with_tools.invoke(messages)
            except Exception as exc:
                if structured_enabled and is_structured_mode_provider_error(exc):
                    llm_with_tools = base_llm_with_tools
                    structured_enabled = False
                    return llm_with_tools.invoke(messages)
                raise
        
        for eq_id in equipment_ids:
            # Get the equipment element from equipment list
            eq_json = next(
                (eq for eq in equipment_list if eq.get("id", "") == eq_id),
                None
            )
            if not eq_json:
                raise ValueError(f"Equipment with ID {eq_id} not found")
            
            print(f"DEBUG: Processing {eq_id}: {eq_json.get('name', '')}")
            
            base_prompt = equipment_sizing_prompt_with_tools(
                stream_data_json=json.dumps(stream_list),
                equipment_data_json=json.dumps(eq_json)
            )
            
            prompt = ChatPromptTemplate.from_messages(base_prompt.messages)
            conversation = list(state.get("messages", []))
            conversation.extend(prompt.format_messages())

            result = safe_invoke(conversation)
            result_message, parsed_payload, parsing_error = unpack_structured_result(result)
            conversation.append(result_message)

            safety_counter = 0
            max_iterations = 5

            while getattr(result_message, "tool_calls", []) and safety_counter < max_iterations:
                for call in result_message.tool_calls:
                    tool_handler = tool_map.get(call["name"])
                    if tool_handler is None:
                        error_msg = (
                            f"Tool '{call['name']}' not available. "
                            "Returning message for LLM handling."
                        )
                        conversation.append(
                            ToolMessage(content=error_msg, tool_call_id=call["id"])
                        )
                        continue

                    tool_result = tool_handler.invoke(call["args"])
                    if not isinstance(tool_result, str):
                        try:
                            tool_result = json.dumps(tool_result)
                        except (TypeError, ValueError):
                            tool_result = str(tool_result)

                    conversation.append(
                        ToolMessage(content=tool_result, tool_call_id=call["id"])
                    )

                result = safe_invoke(conversation)
                result_message, parsed_payload, parsing_error = unpack_structured_result(result)
                conversation.append(result_message)
                safety_counter += 1

            # print(result_message)
            
            if structured_enabled and parsed_payload is not None and parsing_error is None:
                if isinstance(parsed_payload, (dict, list)):
                    try:
                        report = json.dumps(parsed_payload)
                    except (TypeError, ValueError):
                        report = str(parsed_payload)
                else:
                    report = str(parsed_payload)
            else:
                report = result_message.content if getattr(result_message, "content", None) else ""
                if report:
                    raw_json, _ = extract_first_json_document(report)
                    if raw_json:
                        report = raw_json.strip()
                    closing_brace = report.rfind("}")
                    closing_bracket = report.rfind("]")
                    closing_index = max(closing_brace, closing_bracket)
                    if closing_index != -1:
                        report = report[: closing_index + 1]
                else:
                    report = '{"message":"error"}'

            state["messages"] = conversation

            # print(f"id = {eq_id}, report = {report}")
            
            # Update the equipment for processed equipment in the master equipment list table
            updated_payload = json.loads(report)
            if isinstance(updated_payload, list):
                updated_payload = next(
                    (item for item in updated_payload if item.get("id") == eq_id),
                    None,
                )

            if not isinstance(updated_payload, dict):
                raise ValueError(
                    f"Expected dict for equipment '{eq_id}', received {type(updated_payload)}"
                )

            for eq in equipment_stream_list_dict.get("equipments", []):
                # print(f"DEBUG: {eq.get('id', '')} == {eq_id}")
                if eq.get("id", "") == eq_id:
                    # print(f"- Update new sizing_parameters for {eq_id}")
                    # print(f"-- {updated_payload.get('sizing_parameters', '')}")
                    if "sizing_parameters" not in eq:
                        eq["sizing_parameters"] = []
                    else:
                        eq["sizing_parameters"] = updated_payload.get("sizing_parameters", [])
                        break
            print(f"---")
    # print(equipment_stream_list_dict)
    return equipment_stream_list_dict

def equipment_sizing_prompt_with_tools(
    stream_data_json: str,
    equipment_data_json: str,
    equipment_list_json: str = None,
) -> ChatPromptTemplate:
    """Create prompt with pre-computed tool results"""
    
    system_content = f"""
You are a **Lead Equipment Sizing Engineer** responsible for finalizing equipment specifications using automated sizing tools.

**Context:**

  * You have access to sizing calculations tools (heat exchangers, pumps, vessels, compressors).
  * Your task is to use these tools to fill in the missing values in the final equipment specification JSON, adding engineering judgment and filling gaps where tools could not be applied.
  * I want the equipment list with the upadte sizing_parameter of the equipment provided from user.
  
**Tool Available:** `size_heat_exchanger_basic`, `size_pump_basic`, `size_vessel_basic`, `size_compressor_basic`.

**Instructions:**

  1. **Use Sizing Tool:** to calculate the equipment specification values.
  
  2. **Populate Sizing Parameters:** Use tool results to fill the `sizing_parameters` array. For example:
     - Heat Exchanger: ["Area: <area_m2> m", "LMTD: <lmtd_C> C", "U: <U_design_W_m2K> W/mK"]
     - Pump: ["Flow: <flow_m3_hr> m/h", "Head: <total_head_m> m", "Power: <motor_rating_kW> kW"]
     - Vessel: ["Diameter: <diameter_mm> mm", "Length: <length_mm> mm", "Thickness: <shell_thickness_mm> mm"]
     - Compressor: ["Stages: <number_of_stages>", "Power: <driver_rating_kW> kW", "Discharge Temp: <discharge_temperature_C> C"]
  
  3. **Update Duty/Load Field:** Replace placeholder values with calculated duties (e.g., "21.7 MW" for heat exchanger, "45 kW" for pump motor).
  
  4. **Document in Notes:** Reference the tool used and key assumptions. Example: "Sized using heat_exchanger_sizing tool with LMTD method. U-value estimated at 850 W/mK for hydrocarbon/water service."
  
  5. **Handle Missing Tool Results:** For equipment without tool results (columns, special equipment), use engineering judgment and the stream data to provide reasonable estimates or mark as "TBD".
  
  6. **Update Assumptions:** Add any new global assumptions to `metadata.assumptions`, such as "All pump efficiencies assumed at 75% unless specified."

  7. **Maintain JSON Structure:** Output ONLY a valid JSON object matching the equipment template schema. Do NOT use code fences.
  
  8. **Update the Equipment List:** Use the results from the tool to update the equipment list.

```

**Critical Rules:**

  - All numeric values must have units
  - Round to appropriate precision (areas to 0.1 m, power to nearest kW)
  - Reference tool usage in notes for traceability
  - If tool result contains "error", note the issue and provide manual estimate or "TBD"
  - **Output ONLY the final equipment list JSON object (no code fences, no additional text).**
"""

    human_content = f"""
# DATA FOR ANALYSIS:
---
**Stream Data (JSON):**
{stream_data_json}

**Equipment Template (JSON):**
{equipment_data_json}

**Equipment List (JSON):**
{equipment_list_json}

---

**Output ONLY the final equipment list with updated sizing parameters (JSON): object (no code fences, no additional text).**

"""

    messages = [
        SystemMessagePromptTemplate.from_template(
            jinja_raw(system_content),
            template_format="jinja2",
        ),
        HumanMessagePromptTemplate.from_template(
            jinja_raw(human_content),
            template_format="jinja2",
        ),
    ]

    return ChatPromptTemplate.from_messages(messages)


if __name__ == "__main__":
    main()
